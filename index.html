<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Bank - 本地习题库管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU07EWpWzlzY8CwnwKatUOSCMkbeReiN+27HWseWucFMGJVdCeuOxjz" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.5/dist/dexie.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .katex { font-size: 1.1em; }
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* 骨架屏动画 */
        .skeleton-card {
            background-color: #374151;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        .skeleton-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        /* Custom styles for option inputs */
        .option-input-group input[type="radio"], .option-input-group input[type="checkbox"] {
            display: none;
        }
        .option-input-group label {
            border: 2px solid #4b5563;
        }
        .option-input-group input:checked + label {
            border-color: #2563eb;
            background-color: #1e40af;
        }
        /* Practice mode correct/incorrect styling */
        .practice-option-correct {
            border-color: #22c55e !important;
            background-color: #166534 !important;
        }
        .practice-option-incorrect {
             border-color: #ef4444 !important;
            background-color: #991b1b !important;
        }
        /* Mobile Specific Styles */
        @media (max-width: 767px) {
          #questions-grid {
            grid-template-columns: 1fr;
          }
          .question-card-content {
            padding: 1.5rem; /* More padding on mobile */
          }
        }
        /* ===== 移动端题目详情模态框优化 ===== */
        @media (max-width: 767px) {
            #view-question-modal {
                align-items: flex-end;
            }
            
            .view-modal-wrapper {
                width: 100%;
                max-width: 100%;
                max-height: 90vh;
                border-radius: 1rem 1rem 0 0;
                display: flex;
                flex-direction: column;
            }
            
            #view-question-modal .bg-gray-800 {
                border-radius: 1rem 1rem 0 0;
                max-height: 85vh;
            }
            
            #view-modal-content {
                font-size: 0.95rem;
                line-height: 1.6;
            }
            
            #view-modal-content h4 {
                font-size: 1rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            
            #view-modal-content .prose {
                font-size: 0.9rem;
            }
            
            #view-modal-content .prose h1,
            #view-modal-content .prose h2,
            #view-modal-content .prose h3 {
                font-size: 1rem;
            }
            
            /* 选项卡片在移动端优化 */
            #view-modal-content .bg-gray-800\/50 {
                padding: 0.75rem;
                border-radius: 0.375rem;
                margin-top: 0.75rem;
            }
            
            #view-modal-content .space-y-1 > div {
                padding: 0.5rem 0;
                word-break: break-word;
            }
        }

        /* ===== 分页控件移动端优化 ===== */
        @media (max-width: 767px) {
            #pagination {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 0;
            }
            
            #pagination > div:first-child {
                text-align: center;
                order: 3;
                font-size: 0.85rem;
            }
            
            #pagination > div:nth-child(2) {
                order: 1;
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            #pagination > div:last-child {
                order: 2;
                display: flex;
                justify-content: center;
                gap: 0.75rem;
                align-items: center;
            }
            
            #pagination label {
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }
            
            #pagination select {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            /* 按钮大小优化 */
            #pagination button {
                padding: 0.4rem 0.6rem !important;
                min-height: auto !important;
                min-width: auto !important;
            }
            
            #pagination button svg {
                width: 1rem;
                height: 1rem;
            }
            
            /* 页码按钮 */
            #page-numbers {
                gap: 0.25rem;
            }
            
            #page-numbers button {
                padding: 0.4rem 0.6rem !important;
                font-size: 0.8rem;
                min-width: 28px;
                min-height: 28px;
            }
        }

        /* ===== 平板端优化 ===== */
        @media (min-width: 768px) and (max-width: 1024px) {
            #view-modal-content {
                font-size: 0.95rem;
            }
            
            #view-modal-content .prose {
                font-size: 0.9rem;
            }
            
            #pagination {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
        }

        /* ===== 模态框头部优化 ===== */
        @media (max-width: 767px) {
            #view-question-modal .p-6.border-b {
                padding: 1rem;
            }
            
            #view-modal-title {
                font-size: 1.25rem;
            }
            
            #view-modal-close-btn {
                padding: 0.25rem 0.5rem;
            }
        }

        /* ===== 增强的响应式内容 ===== */
        @media (max-width: 767px) {
            #view-modal-content .mt-4 {
                margin-top: 0.75rem;
            }
            
            #view-modal-content .mb-2 {
                margin-bottom: 0.5rem;
            }
            
            #view-modal-content .border-t {
                margin-top: 0.75rem;
                padding-top: 0.75rem;
            }
            
            /* 改进的文本颜色对比 */
            #view-modal-content .text-green-400 {
                color: #4ade80;
            }
            
            #view-modal-content .text-cyan-400 {
                color: #22d3ee;
            }
            
            #view-modal-content .text-yellow-400 {
                color: #facc15;
            }
            
            #view-modal-content .text-purple-400 {
                color: #c084fc;
            }
        }
        /* ===== IO模态框移动端优化 ===== */
        @media (max-width: 767px) {
            #io-modal {
                align-items: flex-end;
            }
            
            #io-modal .bg-gray-800 {
                width: 100%;
                max-width: 100%;
                border-radius: 1.5rem 1.5rem 0 0;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            #io-modal .flex.justify-between {
                padding: 1rem;
                flex-direction: row;
                align-items: center;
            }
            
            #io-modal h3 {
                font-size: 1.25rem;
            }
            
            #io-modal #io-close-btn {
                font-size: 1.75rem;
            }
            
            /* 网格布局改为单列 */
            #io-modal .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* 导入导出卡片优化 */
            #io-modal .space-y-4.bg-gray-900 {
                padding: 1rem;
            }
            
            #io-modal h4 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            #io-modal p {
                font-size: 0.85rem;
                line-height: 1.4;
                margin-bottom: 0.75rem;
            }
            
            /* 文件输入优化 */
            #io-modal .import-file-input {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            #io-modal .import-file-input::file-selector-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.5rem;
            }
            
            /* 按钮优化 */
            #io-modal .export-btn,
            #io-modal .template-download-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                border-radius: 0.5rem;
                min-height: 44px;
                transition: all 0.2s;
            }
            
            #io-modal .export-btn:active,
            #io-modal .template-download-btn:active {
                background-color: #6b7280;
                transform: scale(0.98);
            }
            
            #io-modal .template-download-btn {
                font-size: 0.85rem;
                padding: 0.65rem 0.8rem;
            }
            
            /* 模板下载网格 */
            #io-modal .grid.grid-cols-3 {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 0.75rem;
            }
            
            #io-modal .grid.grid-cols-3 button {
                padding: 0.65rem 0.5rem;
                font-size: 0.75rem;
            }
            
            /* 危险操作区域 */
            #io-modal .bg-red-900\\\/50 {
                padding: 1rem;
                margin: 1rem 0 0 0;
            }
            
            #io-modal .bg-red-900\\\/50 h4 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }
            
            #io-modal .bg-red-900\\\/50 p {
                margin-bottom: 0.75rem;
            }
            
            #io-modal #delete-all-questions-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                min-height: 44px;
                border-radius: 0.5rem;
            }
            
            /* 内容间距优化 */
            #io-modal .space-y-4 > * {
                margin-bottom: 0.75rem;
            }
            
            #io-modal .mt-6 {
                margin-top: 1rem;
            }
        }

        /* ===== 平板端优化 ===== */
        @media (min-width: 768px) and (max-width: 1024px) {
            #io-modal .bg-gray-800 {
                max-height: 85vh;
            }
            
            #io-modal .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            #io-modal .grid.grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
            }
            
            #io-modal .export-btn,
            #io-modal .template-download-btn {
                font-size: 0.9rem;
                padding: 0.65rem;
            }
        }

        /* ===== 桌面端保持 ===== */
        @media (min-width: 1025px) {
            #io-modal {
                align-items: center;
                justify-content: center;
            }
            
            #io-modal .bg-gray-800 {
                border-radius: 0.75rem;
                max-width: 48rem;
                max-height: 80vh;
            }
        }
        /* ===== 通用响应式改进 ===== */
        #io-modal .bg-gray-800 {
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        #io-modal > div > * {
            flex-shrink: 0;
        }

        #io-modal > div > div:last-child {
            flex-shrink: 1;
            overflow-y: auto;
        }

        /* 滚动优化 */
        #io-modal .bg-gray-800 {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }

        #io-modal .bg-gray-800::-webkit-scrollbar {
            width: 6px;
        }

        #io-modal .bg-gray-800::-webkit-scrollbar-track {
            background: #1f2937;
        }

        #io-modal .bg-gray-800::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        #io-modal .bg-gray-800::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* 文件输入自定义样式 */
        .import-file-input {
            display: block;
            width: 100%;
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .import-file-input::file-selector-button {
            all: unset;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 0;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: #0891b2;
            color: white;
            margin-right: 1rem;
            transition: background-color 0.2s;
            min-height: 36px;
            display: inline-flex;
            align-items: center;
        }

        .import-file-input::file-selector-button:hover {
            background-color: #06b6d4;
        }

        .import-file-input::file-selector-button:active {
            background-color: #0a8096;
        }

        @media (max-width: 767px) {
            .import-file-input::file-selector-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.5rem;
                min-height: 36px;
            }
        }
        .btn-mobile-touch {
          padding: 0.75rem 1rem; /* Equivalent to py-3 px-4 */
          min-height: 44px;
          min-width: 44px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        .markdown-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            margin-bottom: -1px;
            padding: 4px 8px;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-bottom: none;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .markdown-toolbar button {
            background-color: transparent;
            border: 1px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .markdown-toolbar button:hover {
            background-color: #4b5563;
            color: #e5e7eb;
        }
        .markdown-toolbar + textarea {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        .markdown-toolbar input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
        }
        .markdown-toolbar input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: 1px solid #6b7280;
        }
        .markdown-toolbar input[type="color"]::-moz-color-swatch {
            border-radius: 4px;
            border: 1px solid #6b7280;
        }
        
        /* New styles for practice mode */
        .navigator-btn.active {
            background-color: #0e7490;
            color: white;
            font-weight: bold;
        }
        .navigator-btn.answered {
            background-color: #1d4ed8;
            color: white;
        }
        .navigator-btn.correct {
            background-color: #166534;
            color: white;
        }
        .navigator-btn.incorrect {
            background-color: #991b1b;
            color: white;
        }
        .mobile-practice-tab.active {
            border-color: #0891b2;
            color: #0891b2;
            background-color: #374151;
        }
        .sub-questions-preview p:not(:last-child) {
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
        }
    </style>
    <style>
    /* 检查答案按钮的移动端优化 */
    @media (max-width: 767px) {
        #practice-modal .mt-auto {
            flex-direction: column-reverse;
        }
        
        #check-answer-btn, 
        #show-answer-btn {
            font-size: 0.875rem;
            padding: 0.75rem 1rem;
            min-height: 44px;
            width: 100%;
        }
        
        #check-answer-btn svg, 
        #show-answer-btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        #review-buttons {
            width: 100%;
        }
        
        #review-buttons .review-btn {
            font-size: 0.75rem;
            padding: 0.75rem 0.5rem;
            min-height: 44px;
            flex: 1;
        }
        
        #review-buttons .review-btn span {
            display: block;
            word-break: keep-all;
        }
    }
    
    /* 平板端优化 */
    @media (min-width: 768px) and (max-width: 1024px) {
        #check-answer-btn, 
        #show-answer-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        #review-buttons .review-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }
        
        #check-answer-btn svg, 
        #show-answer-btn svg {
            width: 1rem;
            height: 1rem;
        }
    }
    
    /* 桌面端优化 */
    @media (min-width: 1025px) {
        #check-answer-btn span,
        #show-answer-btn span {
            display: inline;
        }
        
        #check-answer-btn svg,
        #show-answer-btn svg {
            display: none;
        }
        
        #review-buttons .review-btn span {
            display: inline;
        }
    }
    
    /* 通用按钮交互优化 */
    #check-answer-btn:active,
    #show-answer-btn:active,
    .review-btn:active {
        transform: scale(0.98);
    }
    
    #check-answer-btn:disabled,
    #show-answer-btn:disabled,
    .review-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
</head>
<body class="bg-gray-800 text-gray-200 antialiased">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20 shadow-md p-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-cyan-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" fill="currentColor"/><path d="M12.5 7v5.5l4.5 2.5-1 1.73L11 13V7h1.5z" fill="currentColor"/></svg>
                    <h1 class="text-2xl font-bold text-white">Q-Bank</h1>
                </div>
                <div class="flex-1 max-w-xl">
                    <input type="search" id="search-box" placeholder="搜索题干、解析、标签..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div class="hidden md:flex items-center gap-2">
                    <button id="start-practice-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg flex items-center gap-2 btn-mobile-touch" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>开始练习</span>
                    </button>
                    <button id="add-question-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg flex items-center gap-2 btn-mobile-touch">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>添加题目</span>
                    </button>
                    <button id="io-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center gap-2 btn-mobile-touch">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        <span>导入/导出</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 mb-20 md:mb-0">
            <div class="max-w-7xl mx-auto">
                <div class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-2">
                    <div id="filter-tags-wrapper" class="flex-1">
                        <div id="filter-tags" 
                            class="flex flex-wrap gap-2 max-h-12 md:max-h-none overflow-hidden transition-all duration-300">
                            </div>
                    </div>

                    <button id="toggle-tags-btn" 
                            class="md:hidden text-cyan-400 text-sm self-start py-1 px-2 rounded hover:bg-gray-700">
                        显示更多
                    </button>
                </div>

                <div id="skeleton-loader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="skeleton-card h-96"></div>
                    <div class="skeleton-card h-96"></div>
                    <div class="skeleton-card h-96"></div>
                    <div class="skeleton-card h-96"></div>
                    <div class="skeleton-card h-96"></div>
                    <div class="skeleton-card h-96"></div>
                </div>

                <div id="questions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                 <div id="no-results" class="text-center py-20 hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-xl font-medium text-gray-300">未找到题目</h3>
                    <p class="mt-1 text-sm text-gray-500">尝试更换搜索词或清空筛选条件。</p>
                </div>
                <!-- Pagination -->
                <div id="pagination" class="mt-8 flex items-center justify-between hidden">
                    <div class="text-sm text-gray-400">
                        显示 <span id="page-start">1</span> - <span id="page-end">9</span> 共 <span id="total-count">0</span> 题
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="first-page-btn" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white disabled:opacity-50 disabled:cursor-not-allowed transition btn-mobile-touch">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                        </button>
                        <button id="prev-page-btn" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white disabled:opacity-50 disabled:cursor-not-allowed transition btn-mobile-touch">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <div id="page-numbers" class="flex gap-1">
                            </div>
                        <button id="next-page-btn" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white disabled:opacity-50 disabled:cursor-not-allowed transition btn-mobile-touch">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <button id="last-page-btn" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white disabled:opacity-50 disabled:cursor-not-allowed transition btn-mobile-touch">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-400">每页:</label>
                        <select id="page-size-select" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="9">9</option>
                            <option value="12">12</option>
                            <option value="18">18</option>
                            <option value="24">24</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>
        </main>
    </div>

     <!-- Mobile Action Bar -->
     <div id="mobile-action-bar" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm p-2 flex justify-around items-center border-t border-gray-700 z-30">
        <button id="mobile-add-question-btn" class="text-cyan-400 font-medium py-2 px-4 rounded-lg transition duration-200 flex flex-col items-center gap-1 btn-mobile-touch">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span class="text-xs">添加</span>
        </button>
        <button id="mobile-start-practice-btn" class="text-green-400 font-medium py-2 px-4 rounded-lg transition duration-200 flex flex-col items-center gap-1 btn-mobile-touch" disabled>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-xs">练习</span>
        </button>
        <button id="mobile-io-btn" class="text-gray-300 font-medium py-2 px-4 rounded-lg transition duration-200 flex flex-col items-center gap-1 btn-mobile-touch">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
            <span class="text-xs">导入/导出</span>
        </button>
    </div>

    <!-- Question Editor Modal -->
    <div id="question-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-white">添加新题目</h2>
                <div class="w-1/4">
                    <select id="question-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <option value="standard">标准题 (简答/填空)</option>
                        <option value="single-choice">单选题</option>
                        <option value="multi-choice">多选题</option>
                        <option value="material">材料题</option>
                    </select>
                </div>
            </div>
            <form id="question-form" class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <input type="hidden" id="question-id">
                <div class="md:w-1/2 p-6 bg-gray-900 overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-2">实时预览</h3>
                    <div id="preview-area" class="prose prose-invert prose-sm max-w-none bg-gray-800 p-4 rounded-lg min-h-[200px] text-gray-300"></div>
                </div>
                <div class="md:w-1/2 p-6 space-y-4 overflow-y-auto">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="question-stem" class="block text-sm font-medium text-gray-300">题干 / 材料</label>
                            <div class="flex gap-2">
                                <button type="button" id="parse-stem-btn" class="hidden bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-md transition btn-mobile-touch flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                    <span>解析</span>
                                </button>
                                <button type="button" id="paste-and-parse-btn" class="lg:hidden bg-cyan-700 hover:bg-cyan-600 text-white text-xs font-bold py-1 px-3 rounded-md transition btn-mobile-touch flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2h-1a1 1 0 110-2h1a4 4 0 014 4v11a4 4 0 01-4 4H6a4 4 0 01-4-4V5a4 4 0 014-4h1a1 1 0 110 2H6z"></path></svg>
                                    <span>粘贴</span>
                                </button>
                            </div>
                        </div>
                        <div class="markdown-toolbar">
                            <button type="button" data-md="bold" title="加粗"><b>B</b></button>
                            <button type="button" data-md="italic" title="斜体"><i>I</i></button>
                            <button type="button" data-md="strike" title="删除线"><s>S</s></button>
                            <button type="button" data-md="code" title="行内代码" class="font-mono text-xs">&lt;/&gt;</button>
                            <button type="button" data-md="katex" title="行内公式" class="font-mono">Σ</button>
                            <button type="button" data-md="katex-block" title="块级公式" class="font-mono">[Σ]</button>
                            <div class="w-px h-5 bg-gray-500 mx-1"></div>
                            <button type="button" data-md="textcolor" title="文本颜色"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M4.143 14.437V4.063h1.385v5.333h3.58V4.063h1.385v10.374H9.108V9.125H5.528v5.312H4.143zM0 15.5V15h16v.5H0z"/></svg></button>
                            <input type="color" class="markdown-color-input" data-for="textcolor" value="#dd2f58" title="选择文本颜色">
                            <button type="button" data-md="bgcolor" title="背景高亮"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M12.653 7.564l1.347 1.347-2.653 2.653-1.347-1.347 2.653-2.653zm1.5-1.5L13.106 5.017 9.394 8.729l1.04 1.04 4.719-4.719zM1 14h14v1H1v-1z"/><path d="M9.313 9.408l-4.93-4.93-1.04 1.04 4.93 4.93 1.04-1.04zM3.56 10.82l.849.849 1.326-1.326-.85-.85-1.325 1.327zM2.5 13.5c.076 0 .152-.03.212-.09l1.712-1.712a.5.5 0 0 0-.707-.707L1.995 12.7a.5.5 0 0 0 .212.912z"/></svg></button>
                            <input type="color" class="markdown-color-input" data-for="bgcolor" value="#FFEB3B" title="选择背景颜色">
                        </div>
                        <textarea id="question-stem" rows="8" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" required></textarea>
                    </div>

                    <div id="options-editor" class="hidden space-y-2">
                        <label class="block text-sm font-medium text-gray-300">选项</label>
                        <div id="options-container"></div>
                        <button type="button" id="add-option-btn" class="text-cyan-400 text-sm hover:text-cyan-300 btn-mobile-touch">+ 添加选项</button>
                    </div>
                    
                    <div id="standard-answer-editor">
                        <label for="question-answer" class="block text-sm font-medium text-gray-300 mb-1">答案</label>
                         <div class="markdown-toolbar">
                            <button type="button" data-md="bold" title="加粗"><b>B</b></button>
                            <button type="button" data-md="italic" title="斜体"><i>I</i></button>
                            <button type="button" data-md="strike" title="删除线"><s>S</s></button>
                            <button type="button" data-md="code" title="行内代码" class="font-mono text-xs">&lt;/&gt;</button>
                            <button type="button" data-md="katex" title="行内公式" class="font-mono">Σ</button>
                            <button type="button" data-md="katex-block" title="块级公式" class="font-mono">[Σ]</button>
                            <div class="w-px h-5 bg-gray-500 mx-1"></div>
                            <button type="button" data-md="textcolor" title="文本颜色"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M4.143 14.437V4.063h1.385v5.333h3.58V4.063h1.385v10.374H9.108V9.125H5.528v5.312H4.143zM0 15.5V15h16v.5H0z"/></svg></button>
                            <input type="color" class="markdown-color-input" data-for="textcolor" value="#dd2f58" title="选择文本颜色">
                            <button type="button" data-md="bgcolor" title="背景高亮"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M12.653 7.564l1.347 1.347-2.653 2.653-1.347-1.347 2.653-2.653zm1.5-1.5L13.106 5.017 9.394 8.729l1.04 1.04 4.719-4.719zM1 14h14v1H1v-1z"/><path d="M9.313 9.408l-4.93-4.93-1.04 1.04 4.93 4.93 1.04-1.04zM3.56 10.82l.849.849 1.326-1.326-.85-.85-1.325 1.327zM2.5 13.5c.076 0 .152-.03.212-.09l1.712-1.712a.5.5 0 0 0-.707-.707L1.995 12.7a.5.5 0 0 0 .212.912z"/></svg></button>
                            <input type="color" class="markdown-color-input" data-for="bgcolor" value="#FFEB3B" title="选择背景颜色">
                        </div>
                        <textarea id="question-answer" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"></textarea>
                    </div>

                    <div id="sub-questions-editor" class="hidden space-y-2">
                        <label class="block text-sm font-medium text-gray-300">子问题</label>
                        <div id="sub-questions-container"></div>
                        <button type="button" id="add-sub-question-btn" class="text-cyan-400 text-sm hover:text-cyan-300 btn-mobile-touch">+ 添加子问题</button>
                    </div>

                     <div>
                        <label for="question-analysis" class="block text-sm font-medium text-gray-300 mb-1">解析</label>
                         <div class="markdown-toolbar">
                            <button type="button" data-md="bold" title="加粗"><b>B</b></button>
                            <button type="button" data-md="italic" title="斜体"><i>I</i></button>
                            <button type="button" data-md="strike" title="删除线"><s>S</s></button>
                            <button type="button" data-md="code" title="行内代码" class="font-mono text-xs">&lt;/&gt;</button>
                            <button type="button" data-md="katex" title="行内公式" class="font-mono">Σ</button>
                            <button type="button" data-md="katex-block" title="块级公式" class="font-mono">[Σ]</button>
                            <div class="w-px h-5 bg-gray-500 mx-1"></div>
                            <button type="button" data-md="textcolor" title="文本颜色"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M4.143 14.437V4.063h1.385v5.333h3.58V4.063h1.385v10.374H9.108V9.125H5.528v5.312H4.143zM0 15.5V15h16v.5H0z"/></svg></button>
                            <input type="color" class="markdown-color-input" data-for="textcolor" value="#dd2f58" title="选择文本颜色">
                            <button type="button" data-md="bgcolor" title="背景高亮"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M12.653 7.564l1.347 1.347-2.653 2.653-1.347-1.347 2.653-2.653zm1.5-1.5L13.106 5.017 9.394 8.729l1.04 1.04 4.719-4.719zM1 14h14v1H1v-1z"/><path d="M9.313 9.408l-4.93-4.93-1.04 1.04 4.93 4.93 1.04-1.04zM3.56 10.82l.849.849 1.326-1.326-.85-.85-1.325 1.327zM2.5 13.5c.076 0 .152-.03.212-.09l1.712-1.712a.5.5 0 0 0-.707-.707L1.995 12.7a.5.5 0 0 0 .212.912z"/></svg></button>
                            <input type="color" class="markdown-color-input" data-for="bgcolor" value="#FFEB3B" title="选择背景颜色">
                        </div>
                        <textarea id="question-analysis" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"></textarea>
                    </div>
                    <div>
                        <label for="question-tags" class="block text-sm font-medium text-gray-300 mb-1">标签 (逗号分隔)</label>
                        <input type="text" id="question-tags" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                    </div>
                </div>
            </form>
             <div class="p-6 border-t border-gray-700 flex justify-end gap-4 bg-gray-800/50">
                <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">取消</button>
                <button type="button" id="save-and-add-another-btn" class="bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">保存并继续添加</button>
                <button type="submit" form="question-form" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">保存</button>
            </div>
        </div>
    </div>
    
    <!-- Practice Modal -->
    <div id="practice-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex-col justify-center items-center hidden p-2 sm:p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col p-4 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                 <div id="practice-progress" class="text-lg font-mono text-cyan-400">1 / 10</div>
                 <div id="practice-question-type" class="text-sm font-semibold bg-gray-700 text-cyan-300 px-3 py-1 rounded-full shadow-sm"></div>
                 <button id="close-practice-btn" class="text-gray-400 hover:text-white text-3xl leading-none btn-mobile-touch">&times;</button>
            </div>
            
            <!-- Mobile Tabs -->
            <div id="mobile-practice-tabs" class="md:hidden flex border-b border-gray-700 mb-4">
                <button data-tab="material" class="mobile-practice-tab flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400 active">阅读材料</button>
                <button data-tab="questions" class="mobile-practice-tab flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400">作答区域</button>
            </div>

            <!-- Main Practice Content Area -->
            <div id="practice-content-area" class="flex-1 flex flex-col md:flex-row gap-4 sm:gap-6 overflow-hidden">
                <!-- Material Pane (Left Column on Desktop) -->
                <div id="practice-material-pane" class="practice-tab-content prose prose-invert max-w-none bg-gray-900 p-4 rounded-lg overflow-y-auto md:w-5/12">
                    <div id="practice-stem-content"></div>
                </div>
                
                <!-- Questions Pane (Right Column on Desktop) -->
                <div id="practice-questions-pane" class="practice-tab-content flex-1 flex flex-col overflow-hidden md:w-7/12 hidden md:flex">
                    <div id="practice-navigator" class="mb-4 flex flex-wrap gap-2"></div>
                    <div id="practice-sub-questions-area" class="flex-1 overflow-y-auto space-y-4 pr-2"></div>
                </div>
            </div>

            <div id="practice-feedback-area" class="my-2 text-center"></div>
            <div id="practice-answer-area" class="flex-1 overflow-y-auto p-4 bg-gray-900 rounded-lg prose prose-invert max-w-none hidden"></div>
            
            <!-- Action Buttons -->
            <div class="mt-auto pt-4 sm:pt-6 flex flex-col-reverse sm:flex-row justify-between items-stretch sm:items-center gap-3 sm:gap-4">
                <!-- 左侧：检查答案/显示答案按钮 -->
                <div class="flex gap-2 sm:gap-3 w-full sm:w-auto">
                    <button id="check-answer-btn" class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold py-3 sm:py-2 px-4 sm:px-6 rounded-lg transition duration-200 btn-mobile-touch flex items-center justify-center gap-2 min-h-[44px] sm:min-h-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-sm sm:text-base">检查答案</span>
                    </button>
                    <button id="show-answer-btn" class="flex-1 sm:flex-none bg-gray-600 hover:bg-gray-500 active:bg-gray-700 text-white font-bold py-3 sm:py-2 px-4 sm:px-6 rounded-lg transition duration-200 btn-mobile-touch flex items-center justify-center gap-2 min-h-[44px] sm:min-h-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <span class="text-sm sm:text-base">显示答案</span>
                    </button>
                </div>

                <!-- 右侧：复习按钮组 -->
                <div id="review-buttons" class="hidden w-full sm:w-auto flex items-center gap-2 sm:gap-3">
                    <button data-status="mastered" class="review-btn flex-1 sm:flex-none bg-green-600 hover:bg-green-500 active:bg-green-700 text-white font-bold py-3 sm:py-2 px-3 sm:px-4 text-center rounded-lg transition duration-200 btn-mobile-touch min-h-[44px] sm:min-h-auto flex items-center justify-center">
                        <span class="text-xs sm:text-sm">掌握</span>
                    </button>
                    <button data-status="reviewing" class="review-btn flex-1 sm:flex-none bg-yellow-600 hover:bg-yellow-500 active:bg-yellow-700 text-white font-bold py-3 sm:py-2 px-3 sm:px-4 text-center rounded-lg transition duration-200 btn-mobile-touch min-h-[44px] sm:min-h-auto flex items-center justify-center">
                        <span class="text-xs sm:text-sm">模糊</span>
                    </button>
                    <button data-status="new" class="review-btn flex-1 sm:flex-none bg-red-600 hover:bg-red-500 active:bg-red-700 text-white font-bold py-3 sm:py-2 px-3 sm:px-4 text-center rounded-lg transition duration-200 btn-mobile-touch min-h-[44px] sm:min-h-auto flex items-center justify-center">
                        <span class="text-xs sm:text-sm">遗忘</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="practice-options-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-end md:items-center justify-center hidden p-0 md:p-4">
        <div class="bg-gray-800 rounded-t-xl md:rounded-xl shadow-2xl w-full max-w-md flex flex-col">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 id="practice-options-title" class="text-2xl font-bold text-white">练习设置</h2>
                <button id="practice-options-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none btn-mobile-touch">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">练习模式</label>
                    <div class="space-y-2" id="practice-mode-group">
                        <label class="flex items-center p-3 rounded-lg bg-gray-700 border-2 border-gray-700 has-[:checked]:border-cyan-500 cursor-pointer transition">
                            <input type="radio" name="practice-mode" value="smart" class="w-4 h-4 text-cyan-600 bg-gray-900 border-gray-600 focus:ring-cyan-500" checked>
                            <span class="ml-3 block text-sm font-medium text-white">智能练习</span>
                            <span class="ml-auto text-xs text-gray-400">优先新题/错题</span>
                        </label>
                        <label class="flex items-center p-3 rounded-lg bg-gray-700 border-2 border-gray-700 has-[:checked]:border-cyan-500 cursor-pointer transition">
                            <input type="radio" name="practice-mode" value="mistakes" class="w-4 h-4 text-cyan-600 bg-gray-900 border-gray-600 focus:ring-cyan-500">
                            <span class="ml-3 block text-sm font-medium text-white">错题回顾</span>
                            <span class="ml-auto text-xs text-gray-400">仅练习错题</span>
                        </label>
                        <label class="flex items-center p-3 rounded-lg bg-gray-700 border-2 border-gray-700 has-[:checked]:border-cyan-500 cursor-pointer transition">
                            <input type="radio" name="practice-mode" value="random" class="w-4 h-4 text-cyan-600 bg-gray-900 border-gray-600 focus:ring-cyan-500">
                            <span class="ml-3 block text-sm font-medium text-white">全量随机</span>
                            <span class="ml-auto text-xs text-gray-400">打乱所有题目</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="practice-limit" class="block text-sm font-medium text-gray-300 mb-2">练习题量</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="practice-limit" name="practice-limit" value="20" min="1" class="w-24 bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <span id="practice-limit-label" class="text-sm text-gray-400">/ 共 0 题</span>
                    </div>
                </div>
            </div>
             <div class="p-6 border-t border-gray-700 flex justify-end gap-4 bg-gray-800/50">
                <button type="button" id="practice-options-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">取消</button>
                <button type="button" id="practice-options-start-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">开始</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 id="confirm-title" class="text-xl font-bold text-white mb-2">确认删除？</h3>
            <p id="confirm-message" class="text-gray-400 mb-6">此操作不可撤销。</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">取消</button>
                <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition btn-mobile-touch">删除</button>
            </div>
        </div>
    </div>
    
    <!-- View Question Modal -->
    <div id="view-question-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 rounded-xl md:rounded-xl rounded-b-none md:rounded-b-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col view-modal-wrapper">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                <h2 id="view-modal-title" class="text-xl md:text-2xl font-bold text-white flex-1">查看题目详情</h2>
                <button id="view-modal-close-btn" class="text-gray-400 hover:text-white text-2xl md:text-3xl leading-none btn-mobile-touch flex-shrink-0 ml-2">&times;</button>
            </div>
            <div id="view-modal-content" class="flex-1 p-4 md:p-6 overflow-y-auto prose prose-invert max-w-none">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- IO Modal -->
    <div id="io-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 rounded-xl md:rounded-xl rounded-b-none md:rounded-b-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] md:max-h-[80vh]">
            <!-- 头部 -->
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-xl md:text-2xl font-bold text-white flex-1">数据管理</h3>
                <button id="io-close-btn" class="text-gray-400 hover:text-white text-2xl md:text-3xl leading-none btn-mobile-touch flex-shrink-0 ml-2">&times;</button>
            </div>

            <!-- 内容 - 可滚动 -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 md:space-y-6">
                <!-- 导入导出两列布局 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- 导入部分 -->
                    <div class="space-y-3 md:space-y-4 bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-semibold text-cyan-400 border-b border-gray-700 pb-2">导入</h4>
                        <p class="text-xs md:text-sm text-gray-400">支持 .json, .docx 文件。重复 ID 的题目将被更新。</p>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-gray-300 mb-2">从 JSON</label>
                            <input type="file" id="import-json-input" accept=".json" class="import-file-input"/>
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-gray-300 mb-2">从 Word (.docx)</label>
                            <input type="file" id="import-docx-input" accept=".docx" class="import-file-input"/>
                        </div>
                    </div>

                    <!-- 导出部分 -->
                    <div class="space-y-3 md:space-y-4 bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-semibold text-cyan-400 border-b border-gray-700 pb-2">导出</h4>
                        <p class="text-xs md:text-sm text-gray-400">将当前筛选的题目导出。</p>
                        <button id="export-json-btn" class="export-btn w-full">导出为 JSON</button>
                        <button id="export-csv-btn" class="export-btn w-full">导出为 CSV</button>
                        <button id="export-docx-btn" class="export-btn w-full">导出为 Word</button>
                    </div>
                </div>

                <!-- 模板下载部分 -->
                <div class="bg-gray-900 p-4 rounded-lg">
                    <h4 class="font-semibold text-cyan-400 border-b border-gray-700 pb-2 mb-3">下载模板</h4>
                    <p class="text-xs md:text-sm text-gray-400 mb-4">使用标准模板确保题目格式正确，以便顺利导入。</p>
                    <div class="grid grid-cols-3 gap-2 md:gap-3">
                        <button id="download-json-template-btn" class="template-download-btn btn-mobile-touch">JSON</button>
                        <button id="download-csv-template-btn" class="template-download-btn btn-mobile-touch">CSV</button>
                        <button id="download-docx-template-btn" class="template-download-btn btn-mobile-touch">Word</button>
                    </div>
                </div>

                <!-- 危险操作区域 -->
                <div class="bg-red-900/50 p-4 rounded-lg border border-red-700">
                    <h4 class="font-semibold text-red-400 mb-2">危险操作</h4>
                    <p class="text-xs md:text-sm text-gray-400 mb-4">此操作将永久删除您的所有题目，且无法恢复。</p>
                    <button id="delete-all-questions-btn" class="w-full text-center bg-red-600 hover:bg-red-500 active:bg-red-700 text-white p-3 rounded-lg font-bold transition btn-mobile-touch">删除所有题目</button>
                </div>
            </div>
        </div>
    </div>
    <style>
        .import-file-input{ all: unset; display: block; width:100%; font-size: 0.875rem; color: #9ca3af; } .import-file-input::file-selector-button { all: unset; cursor: pointer; margin-right: 1rem; padding: 0.5rem 1rem; border-radius: 9999px; border: 0; font-size: 0.875rem; font-weight: 600; background-color: #0891b2; color: white; } .import-file-input::file-selector-button:hover { background-color: #06b6d4; } 
        .export-btn { display: block; width: 100%; text-align: center; background-color: #374151; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; } .export-btn:hover { background-color: #4b5563; }
        .template-download-btn { display: block; width: 100%; text-align: center; background-color: #374151; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; font-size: 0.875rem; } .template-download-btn:hover { background-color: #4b5563; }
    </style>

    <script type="module">
        // --- 1. SETUP ---
        const db = new Dexie("QBankDB");
        db.version(4).stores({
            questions: '++id, stem, answer, analysis, tags, reviewStatus, createdAt, updatedAt, type, subQuestions, practiceCount, errorCount',
        });

        // --- 2. STATE MANAGEMENT ---
        let state = {
            questions: [],
            filters: { search: '', tags: [] },
            practice: { questions: [], currentIndex: 0, intersectionObserver: null },
            pagination: {
                currentPage: 1,
                pageSize: 9,
            }
        };

        // --- 3. DOM ELEMENTS ---
        const DOMElements = {
            loader: document.getElementById('skeleton-loader'),
            grid: document.getElementById('questions-grid'),
            noResults: document.getElementById('no-results'),
            addBtn: document.getElementById('add-question-btn'),
            modal: document.getElementById('question-modal'),
            modalTitle: document.getElementById('modal-title'),
            form: document.getElementById('question-form'),
            cancelBtn: document.getElementById('cancel-btn'),
            saveAndAddAnotherBtn: document.getElementById('save-and-add-another-btn'),
            previewArea: document.getElementById('preview-area'),
            questionIdInput: document.getElementById('question-id'),
            questionTypeSelect: document.getElementById('question-type'),
            questionStemInput: document.getElementById('question-stem'),
            standardAnswerEditor: document.getElementById('standard-answer-editor'),
            questionAnswerInput: document.getElementById('question-answer'),
            questionAnalysisInput: document.getElementById('question-analysis'),
            questionTagsInput: document.getElementById('question-tags'),
            optionsEditor: document.getElementById('options-editor'),
            optionsContainer: document.getElementById('options-container'),
            addOptionBtn: document.getElementById('add-option-btn'),
            subQuestionsEditor: document.getElementById('sub-questions-editor'),
            subQuestionsContainer: document.getElementById('sub-questions-container'),
            addSubQuestionBtn: document.getElementById('add-sub-question-btn'),
            searchBox: document.getElementById('search-box'),
            filterTagsContainer: document.getElementById('filter-tags'),
            toggleTagsBtn: document.getElementById('toggle-tags-btn'),
            startPracticeBtn: document.getElementById('start-practice-btn'),
            practiceModal: document.getElementById('practice-modal'),
            practiceProgress: document.getElementById('practice-progress'),
            practiceContentArea: document.getElementById('practice-content-area'),
            practiceMaterialPane: document.getElementById('practice-material-pane'),
            practiceQuestionsPane: document.getElementById('practice-questions-pane'),
            practiceStemContent: document.getElementById('practice-stem-content'),
            practiceNavigator: document.getElementById('practice-navigator'),
            practiceSubQuestionsArea: document.getElementById('practice-sub-questions-area'),
            practiceFeedbackArea: document.getElementById('practice-feedback-area'),
            practiceAnswerArea: document.getElementById('practice-answer-area'),
            showAnswerBtn: document.getElementById('show-answer-btn'),
            checkAnswerBtn: document.getElementById('check-answer-btn'),
            reviewButtons: document.getElementById('review-buttons'),
            closePracticeBtn: document.getElementById('close-practice-btn'),
            mobilePracticeTabs: document.getElementById('mobile-practice-tabs'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            viewQuestionModal: document.getElementById('view-question-modal'),
            viewModalTitle: document.getElementById('view-modal-title'),
            viewModalContent: document.getElementById('view-modal-content'),
            viewModalCloseBtn: document.getElementById('view-modal-close-btn'),
            ioBtn: document.getElementById('io-btn'),
            ioModal: document.getElementById('io-modal'),
            ioCloseBtn: document.getElementById('io-close-btn'),
            importJsonInput: document.getElementById('import-json-input'),
            importDocxInput: document.getElementById('import-docx-input'),
            exportJsonBtn: document.getElementById('export-json-btn'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            exportDocxBtn: document.getElementById('export-docx-btn'),
            deleteAllQuestionsBtn: document.getElementById('delete-all-questions-btn'),
            downloadJsonTemplateBtn: document.getElementById('download-json-template-btn'),
            downloadCsvTemplateBtn: document.getElementById('download-csv-template-btn'),
            downloadDocxTemplateBtn: document.getElementById('download-docx-template-btn'),
            paginationContainer: document.getElementById('pagination'),
            pageStart: document.getElementById('page-start'),
            pageEnd: document.getElementById('page-end'),
            totalCount: document.getElementById('total-count'),
            firstPageBtn: document.getElementById('first-page-btn'),
            prevPageBtn: document.getElementById('prev-page-btn'),
            pageNumbers: document.getElementById('page-numbers'),
            nextPageBtn: document.getElementById('next-page-btn'),
            lastPageBtn: document.getElementById('last-page-btn'),
            pageSizeSelect: document.getElementById('page-size-select'),
            mobileAddBtn: document.getElementById('mobile-add-question-btn'),
            mobilePracticeBtn: document.getElementById('mobile-start-practice-btn'),
            mobileIoBtn: document.getElementById('mobile-io-btn'),
            pasteAndParseBtn: document.getElementById('paste-and-parse-btn'),
            parseStemBtn: document.getElementById('parse-stem-btn'),
            practiceQuestionType: document.getElementById('practice-question-type'),
            practiceOptionsModal: document.getElementById('practice-options-modal'),
            practiceOptionsCloseBtn: document.getElementById('practice-options-close-btn'),
            practiceOptionsCancelBtn: document.getElementById('practice-options-cancel-btn'),
            practiceOptionsStartBtn: document.getElementById('practice-options-start-btn'),
            practiceModeGroup: document.getElementById('practice-mode-group'),
            practiceLimitInput: document.getElementById('practice-limit'),
            practiceLimitLabel: document.getElementById('practice-limit-label'),
        };

        // --- 4. UTILS & HELPERS ---
        const shuffleArray = (array) => {
            // 创建一个副本以避免修改原数组 (如果需要)
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        
        const generateUUID = () => crypto.randomUUID();

        const triggerHapticFeedback = () => {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        };

        const applyMarkdown = (textarea, prefix, suffix) => {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const finalSuffix = suffix === undefined ? prefix : suffix;
            const replacement = `${prefix}${selectedText}${finalSuffix}`;
            textarea.setRangeText(replacement, start, end);
            textarea.selectionStart = start + prefix.length;
            textarea.selectionEnd = end + prefix.length;
            textarea.focus();
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        };

        const applyStyleSpan = (textarea, styleProperty, styleValue) => {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const prefix = `<span style="${styleProperty}: ${styleValue}">`;
            const suffix = `</span>`;

            if (!selectedText) {
                textarea.setRangeText(`${prefix}${suffix}`, start, end);
                textarea.selectionStart = start + prefix.length;
                textarea.selectionEnd = textarea.selectionStart;
            } else {
                const replacement = `${prefix}${selectedText}${suffix}`;
                textarea.setRangeText(replacement, start, end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + replacement.length;
            }

            textarea.focus();
            const inputEvent = new Event('input', { bubbles: true });
            textarea.dispatchEvent(inputEvent);
        };
        
        const renderMarkdown = (text) => {
             if (!text) return '';
            const dirtyHtml = marked.parse(text, { breaks: true, gfm: true });
            const cleanHtml = DOMPurify.sanitize(dirtyHtml, { ADD_TAGS: ['span'], ADD_ATTR: ['style'] });
            
            return cleanHtml.replace(/\$\$(.*?)\$\$/g, (match, expression) => {
                try {
                    return katex.renderToString(expression, { throwOnError: false, displayMode: true });
                } catch (e) { console.error("KaTeX rendering error:", e); return match; }
            }).replace(/\$(.*?)\$/g, (match, expression) => {
                try {
                    return katex.renderToString(expression, { throwOnError: false });
                } catch (e) { console.error("KaTeX rendering error:", e); return match; }
            });
        };

        const getAutoTags = (data) => {
            const autoTags = new Set();
            
            // 1. 添加题型标签
            const typeTagMap = {
                'standard': '标准题',
                'single-choice': '单选题',
                'multi-choice': '多选题',
                'material': '材料题'
            };
            if (data.type && typeTagMap[data.type]) {
                autoTags.add(typeTagMap[data.type]);
            }

            // 2. 聚合所有解析文本 (包括子问题)
            let allAnalysisText = data.analysis || '';
            if (data.type === 'material' && data.subQuestions) {
                // 在 saveQuestionData 中, data.subQuestions 已经是对象数组
                const subQs = data.subQuestions;
                subQs.forEach(sq => {
                    if (sq.analysis) allAnalysisText += '\n' + sq.analysis;
                });
            }

            if (!allAnalysisText.trim()) {
                return Array.from(autoTags);
            }

            // 3. 定义关键词提取规则
            
            // 规则 A: 提取完整的考点短语
            // 匹配 "考查[了/的是]..." 或 "考点[为/是]..."
            const phrasePatterns = [
                /(?:本题)?考查(?:了|的是)?(.+?)(?:。|，|\n)/gi,
                /(?:本题)?考点(?:为|在于|是)(.+?)(?:。|，|\n)/gi,
                /(?:主要|重点)测试的是(.+?)(?:。|，|\n)/gi
            ];

            // 规则 B: 从短语中提取核心名词 (用于匹配 "消费税" 这类词)
            const coreNounPatterns = [
                /(\S+税)/g,           // "消费税", "增值税"
                /(\S+法)/g,           // "合同法", "公司法"
                /(\S+准则)/g,         // "会计准则"
                /(\S+原则)/g,         // "基本原则"
                /(\S+的扣除)/g,       // "的扣除"
                /(\S+的计算)/g,       // "的计算"
                /(\S+的处理)/g        // "的处理"
            ];

            const foundPhrases = new Set();

            // 4. 执行规则 A: 提取完整短语
            for (const regex of phrasePatterns) {
                let match;
                while ((match = regex.exec(allAnalysisText)) !== null) {
                    const phrase = match[1].trim().replace(/['"“”]/g, ''); // 清理标点
                    if (phrase.length > 1 && phrase.length < 50) { // 合理长度
                        foundPhrases.add(phrase);
                        autoTags.add(phrase); // 添加完整短语, e.g., "已纳消费税的扣除"
                    }
                }
            }

            // 5. 执行规则 B: 从已找到的短语中提取核心名词
            for (const phrase of foundPhrases) {
                for (const regex of coreNounPatterns) {
                    let match;
                    while ((match = regex.exec(phrase)) !== null) {
                        const coreNoun = match[1].trim();
                        if (coreNoun.length > 1) {
                            autoTags.add(coreNoun); // 添加核心名词, e.g., "消费税"
                        }
                    }
                }
            }
            
            return Array.from(autoTags);
        };

        const generateAndApplyAutoTags = () => {
            // 如果是在编辑题目（ID已存在），则不进行自动标签，防止覆盖用户已保存的标签
            // if (DOMElements.questionIdInput.value) return; 

            const type = DOMElements.questionTypeSelect.value;
            const analysis = DOMElements.questionAnalysisInput.value.trim();
            
            // 构造一个临时的 data 对象以传递给 getAutoTags
            const questionData = {
                type: type,
                analysis: analysis,
                subQuestions: []
            };

            // // 如果是材料题，遍历子问题编辑器，收集它们的解析
            // if (type === 'material') {
            //     DOMElements.subQuestionsContainer.querySelectorAll('[data-sq-id]').forEach(sqNode => {
            //         const sqAnalysis = sqNode.querySelector('textarea[data-field="analysis"]').value.trim();
            //         // 仅添加包含解析的子问题对象
            //         if (sqAnalysis) {
            //             questionData.subQuestions.push({ analysis: sqAnalysis });
            //         }
            //     });
            // }
            
            // 1. 获取自动生成的标签
            const autoTags = getAutoTags(questionData);

            // 2. 获取用户在输入框中已有的标签 (可能来自手动输入或上一次粘贴)
            const existingTags = DOMElements.questionTagsInput.value
                                    .split(/,|，/)
                                    .map(t => t.trim())
                                    .filter(Boolean);
            
            // 3. 合并标签并去重 (自动标签在前)
            const combinedTags = [...new Set([...autoTags, ...existingTags])];
            
            // 4. 将合并后的标签写回输入框
            DOMElements.questionTagsInput.value = combinedTags.join(', ');
        };
        
        // --- 5. UI RENDERING (MODAL EDITORS) ---
        const createSubQuestionNode = (sqInput = {}) => {
            // 将默认值合并移到函数内部，确保 generateUUID() 每次都运行
            const sq = {
                id: generateUUID(),
                type: 'standard',
                stem: '',
                answer: '',
                analysis: '',
                options: [{text: '', isCorrect: false}],
                ...sqInput // 使用传入的 sqInput 覆盖默认值
            };
            
            const div = document.createElement('div');
            div.className = 'p-3 border border-gray-700 rounded-lg space-y-3 bg-gray-900/50';
            div.dataset.sqId = sq.id;

            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <select class="sub-question-type-select w-2/5 bg-gray-600 border border-gray-500 rounded-md p-1 text-xs">
                        <option value="standard" ${sq.type === 'standard' ? 'selected' : ''}>标准题</option>
                        <option value="single-choice" ${sq.type === 'single-choice' ? 'selected' : ''}>单选题</option>
                        <option value="multi-choice" ${sq.type === 'multi-choice' ? 'selected' : ''}>多选题</option>
                    </select>
                    <button type="button" class="remove-sub-question-btn text-red-500 hover:text-red-400 text-xs">删除</button>
                </div>
                <textarea data-field="stem" placeholder="子问题题干" class="w-full bg-gray-700 p-2 rounded-md text-sm">${sq.stem}</textarea>
                <div class="sub-question-answer-area" ${sq.type !== 'standard' ? 'style="display: none;"' : ''}>
                    <textarea data-field="answer" placeholder="子问题答案" class="w-full bg-gray-700 p-2 rounded-md text-sm">${sq.answer || ''}</textarea>
                </div>
                <div class="sub-question-options-area space-y-2" ${sq.type === 'standard' ? 'style="display: none;"' : ''}></div>
                <textarea data-field="analysis" placeholder="子问题解析" class="w-full bg-gray-700 p-2 rounded-md text-sm mt-2">${sq.analysis || ''}</textarea>
            `;
            
            const optionsArea = div.querySelector('.sub-question-options-area');
            if (sq.type !== 'standard' && sq.options) {
                const inputType = sq.type === 'single-choice' ? 'radio' : 'checkbox';
                sq.options.forEach((opt, index) => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'flex items-center gap-2';
                    optDiv.innerHTML = `
                        <input type="${inputType}" name="sub-question-correct-${sq.id}" value="${index}" ${opt.isCorrect ? 'checked' : ''} class="w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded">
                        <input type="text" data-field="option-text" value="${opt.text}" placeholder="选项内容" class="flex-1 bg-gray-700 border border-gray-600 rounded-md p-1 text-sm">
                        <button type="button" class="remove-sub-option-btn text-red-500 hover:text-red-400 text-xs">&times;</button>
                    `;
                    optionsArea.appendChild(optDiv);
                });
                const addOptBtn = document.createElement('button');
                addOptBtn.type = 'button';
                addOptBtn.className = 'add-sub-option-btn text-cyan-400 text-xs hover:text-cyan-300 mt-1';
                addOptBtn.textContent = '+ 添加选项';
                optionsArea.appendChild(addOptBtn);
            }
            return div;
        };

        const renderSubQuestionsEditor = (subQuestions = []) => {
            DOMElements.subQuestionsContainer.innerHTML = '';
            const initialSQ = [{ id: generateUUID(), type: 'standard', stem: '', answer: '', analysis: '', options: [] }];
            const questionsToRender = subQuestions.length > 0 ? subQuestions : initialSQ;
            questionsToRender.forEach(sq => {
                DOMElements.subQuestionsContainer.appendChild(createSubQuestionNode(sq));
            });
        };

        const renderOptionsEditor = (type, options = [{text: '', isCorrect: false}]) => {
            DOMElements.optionsContainer.innerHTML = '';
            const inputType = type === 'single-choice' ? 'radio' : 'checkbox';
            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <input type="${inputType}" id="option-correct-${index}" name="option-correct" value="${index}" ${option.isCorrect ? 'checked' : ''} class="w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500">
                    <input type="text" value="${option.text}" placeholder="选项内容" class="flex-1 bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                    <button type="button" class="remove-option-btn text-red-500 hover:text-red-400">&times;</button>
                `;
                DOMElements.optionsContainer.appendChild(div);
            });
        };

        // --- 6. UI RENDERING (MAIN) ---
        const renderQuestionCard = (q) => {
            const card = document.createElement('div');
            card.className = 'relative group bg-gray-900 rounded-xl shadow-lg flex flex-col transition duration-300 hover:shadow-cyan-500/20 hover:-translate-y-1 h-96 cursor-pointer';
            const practiceCount = q.practiceCount || 0;
            const errorCount = q.errorCount || 0;
            // 计算正确率，避免除以零
            const accuracy = practiceCount > 0 
                ? Math.round(((practiceCount - errorCount) / practiceCount) * 100) 
                : 100;
            const accuracyColor = accuracy < 60 ? 'text-red-400' : (accuracy < 80 ? 'text-yellow-400' : 'text-green-400');

            // 仅在练习过时才显示统计HTML
            const statsHTML = practiceCount > 0 ? `
                <div class="text-xs text-gray-400 flex justify-between items-center mb-4 pt-4 border-t border-gray-800">
                    <span class="px-2 py-0.5 bg-gray-700/50 rounded">练习: ${practiceCount}</span>
                    <span class="px-2 py-0.5 bg-gray-700/50 rounded">错误: ${errorCount}</span>
                    <span class="px-2 py-0.5 bg-gray-700/50 rounded font-semibold ${accuracyColor}">正确率: ${accuracy}%</span>
                </div>
            ` : '';
            card.dataset.id = q.id;

            const tagsHTML = q.tags.map(tag => `<span class="bg-gray-700 text-cyan-400 text-xs font-medium px-2.5 py-1 rounded-full">${tag}</span>`).join(' ');
            let statusColor = q.reviewStatus === 'mastered' ? 'bg-green-500' : q.reviewStatus === 'reviewing' ? 'bg-yellow-500' : 'bg-blue-500';
            
            let contentHTML = `<div class="prose prose-invert prose-sm max-w-none rendered-content">${renderMarkdown(q.stem)}</div>`;
            
            // 为选择题添加选项显示
            if (['single-choice', 'multi-choice'].includes(q.type)) {
                try {
                    const options = JSON.parse(q.options || '[]');
                    if (options.length > 0) {
                        const optionsHTML = options.map((opt, idx) => {
                            const label = String.fromCharCode(65 + idx);
                            // 在卡片预览中显示正确答案
                            return `<div class="flex gap-2${opt.isCorrect ? ' text-green-400 font-semibold' : ''}"><span>${label}.</span><div>${renderMarkdown(opt.text)}</div></div>`;
                        }).join('');
                        contentHTML += `<div class="mt-3 space-y-1 text-sm text-gray-300 bg-gray-800/50 p-3 rounded">${optionsHTML}</div>`;
                    }
                } catch(e) { console.error("Error parsing options:", e); }
            }
            
            let materialActions = '';
            if (q.type === 'material') {
                try {
                    const subQs = JSON.parse(q.subQuestions);
                    materialActions = `<button class="expand-btn text-sm text-cyan-400 hover:text-cyan-300">展开 ${subQs.length} 个子问题</button>`;
                } catch(e) {}
            }

            card.innerHTML = `
                <div class="p-5 flex-1 overflow-y-auto question-card-content">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-200">${q.type === 'material' ? '材料题' : '题目'}</h3>
                        <span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded-md ml-2 whitespace-nowrap">${q.type}</span>
                    </div>
                    ${contentHTML}
                </div>
                <div class="px-5 pb-5 mt-auto">
                    ${materialActions ? `<div class="flex justify-end mb-3">${materialActions}</div>` : ''}
                    <div class="sub-questions-preview hidden prose prose-invert prose-sm max-w-none text-gray-400 mb-4 p-3 bg-gray-800 rounded-md space-y-2"></div>
                    <div class="flex flex-wrap gap-2 mb-4">${tagsHTML}</div>
                    ${statsHTML}
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-3 w-3"><span class="relative inline-flex rounded-full h-3 w-3 ${statusColor}"></span></span>
                            <span class="text-xs text-gray-400">${q.reviewStatus || 'new'}</span>
                        </div>
                        <div class="flex gap-2 md:opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <button class="edit-btn text-gray-400 hover:text-white transition btn-mobile-touch"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button>
                            <button class="delete-btn text-gray-400 hover:text-red-500 transition btn-mobile-touch"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        };
        
        const renderPagination = (totalItems) => {
            const { currentPage, pageSize } = state.pagination;
            const totalPages = Math.ceil(totalItems / pageSize);

            if (totalPages <= 1) {
                DOMElements.paginationContainer.classList.add('hidden');
                return;
            }
            DOMElements.paginationContainer.classList.remove('hidden');

            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(startItem + pageSize - 1, totalItems);
            DOMElements.pageStart.textContent = startItem;
            DOMElements.pageEnd.textContent = endItem;
            DOMElements.totalCount.textContent = totalItems;

            DOMElements.firstPageBtn.disabled = currentPage === 1;
            DOMElements.prevPageBtn.disabled = currentPage === 1;
            DOMElements.nextPageBtn.disabled = currentPage === totalPages;
            DOMElements.lastPageBtn.disabled = currentPage === totalPages;
            
            DOMElements.pageNumbers.innerHTML = '';
            const pagesToShow = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
            } else {
                pagesToShow.push(1);
                if (currentPage > 3) pagesToShow.push('...');
                let start = Math.max(2, currentPage - 1);
                let end = Math.min(totalPages - 1, currentPage + 1);
                for (let i = start; i <= end; i++) pagesToShow.push(i);
                if (currentPage < totalPages - 2) pagesToShow.push('...');
                pagesToShow.push(totalPages);
            }

            pagesToShow.forEach(page => {
                 const pageBtn = document.createElement('button');
                 pageBtn.className = `px-4 py-2 rounded-lg text-sm font-medium transition btn-mobile-touch`;
                if (page === '...') {
                    pageBtn.textContent = '...';
                    pageBtn.disabled = true;
                    pageBtn.className += ' text-gray-400';
                } else {
                    pageBtn.textContent = page;
                    pageBtn.dataset.page = page;
                    pageBtn.className += page === currentPage ? ' bg-cyan-600 text-white' : ' bg-gray-700 hover:bg-gray-600 text-white';
                }
                 DOMElements.pageNumbers.appendChild(pageBtn);
            });
        };

        const renderAllQuestions = () => {
            DOMElements.loader.classList.add('hidden');
            DOMElements.grid.classList.remove('hidden');
            DOMElements.grid.innerHTML = '';
            
            const filteredQuestions = getFilteredQuestions();
            const { currentPage, pageSize } = state.pagination;
            const totalItems = filteredQuestions.length;
            const totalPages = Math.ceil(totalItems / pageSize);

            if (currentPage > totalPages && totalPages > 0) {
                state.pagination.currentPage = totalPages;
            }
            
            const paginatedQuestions = filteredQuestions.slice((state.pagination.currentPage - 1) * pageSize, state.pagination.currentPage * pageSize);

            if (filteredQuestions.length === 0) {
                DOMElements.noResults.classList.remove('hidden');
                DOMElements.grid.classList.add('hidden');
                DOMElements.paginationContainer.classList.add('hidden');
            } else {
                 DOMElements.noResults.classList.add('hidden');
                 DOMElements.grid.classList.remove('hidden');
                paginatedQuestions.forEach(q => {
                    DOMElements.grid.appendChild(renderQuestionCard(q));
                });
            }
            renderPagination(totalItems);
            DOMElements.startPracticeBtn.disabled = filteredQuestions.length === 0;
            DOMElements.mobilePracticeBtn.disabled = filteredQuestions.length === 0;
        };
        
        const renderTagsForFiltering = () => {
            const allTags = [...new Set(state.questions.flatMap(q => q.tags))];
            DOMElements.filterTagsContainer.innerHTML = '';
            allTags.forEach(tag => {
                const button = document.createElement('button');
                button.textContent = tag;
                button.dataset.tag = tag;
                const isActive = state.filters.tags.includes(tag);
                button.className = `px-3 py-1 rounded-full text-sm font-medium transition btn-mobile-touch ${isActive ? 'bg-cyan-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}`;
                DOMElements.filterTagsContainer.appendChild(button);
            });
        };

        // --- 7. DATA & DB LOGIC ---
        const fetchAndRender = async () => {
            DOMElements.loader.classList.remove('hidden');
            DOMElements.grid.classList.add('hidden');
            state.questions = await db.questions.orderBy('createdAt').reverse().toArray();
            setTimeout(() => {
                renderAllQuestions();
                renderTagsForFiltering();
            }, 300);
        };
        
        const getFilteredQuestions = () => {
            return state.questions.filter(q => {
                const searchMatch = state.filters.search ? 
                    (q.stem?.toLowerCase().includes(state.filters.search) ||
                    q.analysis?.toLowerCase().includes(state.filters.search) ||
                    q.tags.some(t => t.toLowerCase().includes(state.filters.search))) 
                    : true;
                const tagsMatch = state.filters.tags.length > 0 ? state.filters.tags.every(ft => q.tags.includes(ft)) : true;
                return searchMatch && tagsMatch;
            });
        };

        // --- 8. MODAL & FORM HANDLING ---
        const openViewModal = async (id) => {
            const q = await db.questions.get(id);
            if (!q) return;

            let contentHTML = `<div class="mb-6 pb-6 border-b border-gray-700">${renderMarkdown(q.stem)}</div>`;
            
            if (q.type === 'material') {
                try {
                    const subQs = JSON.parse(q.subQuestions || '[]');
                    contentHTML += subQs.map((sq, index) => {
                        let answerContent = '';
                        let optionsHTML = '';
                        
                        if (sq.type !== 'standard') {
                            // 显示选项
                            optionsHTML = (sq.options || []).map((opt, optIdx) => {
                                const label = String.fromCharCode(65 + optIdx);
                                const isCorrect = opt.isCorrect ? ' text-green-400 font-semibold' : '';
                                return `<div class="flex gap-2${isCorrect}"><span>${label}.</span><div>${renderMarkdown(opt.text)}</div></div>`;
                            }).join('');
                            answerContent = (sq.options || []).filter(o => o.isCorrect).map((o, idx) => String.fromCharCode(65 + (sq.options.findIndex(opt => opt.text === o.text)))).join(', ');
                        } else {
                            answerContent = sq.answer;
                        }
                        
                        return `
                            <div class="mt-4 pt-4 border-t border-gray-600">
                                <div class="prose prose-invert prose-sm max-w-none font-semibold">${renderMarkdown(`(${index + 1}) ${sq.stem}`)}</div>
                                ${optionsHTML ? `<div class="mt-2 space-y-1 text-sm text-gray-300 bg-gray-800/50 p-3 rounded">${optionsHTML}</div>` : ''}
                                <div class="mt-2"><strong class="text-cyan-400">答案：</strong> ${renderMarkdown(answerContent)}</div>
                                ${sq.analysis ? `<div class="mt-2"><strong class="text-yellow-400">解析：</strong><div class="prose prose-invert prose-sm max-w-none text-gray-400">${renderMarkdown(sq.analysis)}</div></div>` : ''}
                            </div>
                        `;
                    }).join('');

                    if (q.analysis) {
                        contentHTML += `
                            <h4 class="font-bold text-purple-400 mt-6 pt-4 border-t border-dashed border-gray-600 mb-2">材料总体解析</h4>
                            <div class="prose prose-invert prose-sm max-w-none rendered-content">${renderMarkdown(q.analysis)}</div>
                        `;
                    }
                } catch (e) { 
                    console.error("Error rendering view modal for material question", e);
                }
            } else if (['single-choice', 'multi-choice'].includes(q.type)) {
                // 选择题显示选项
                try {
                    const options = JSON.parse(q.options || '[]');
                    if (options.length > 0) {
                        const optionsHTML = options.map((opt, idx) => {
                            const label = String.fromCharCode(65 + idx);
                            const isCorrect = opt.isCorrect ? ' text-green-400 font-semibold' : '';
                            return `<div class="flex gap-2${isCorrect}"><span>${label}.</span><div>${renderMarkdown(opt.text)}</div></div>`;
                        }).join('');
                        contentHTML += `<div class="mt-4"><strong class="text-gray-300">选项：</strong><div class="mt-2 space-y-1 text-sm text-gray-300 bg-gray-800/50 p-3 rounded">${optionsHTML}</div></div>`;
                    }
                } catch(e) {
                    console.error("Error parsing options:", e);
                }
                
                contentHTML += `
                    <div class="mt-4">
                        <h4 class="font-bold text-cyan-400 mb-2">答案</h4>
                        <div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(q.answer)}</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-bold text-yellow-400 mb-2">解析</h4>
                        <div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(q.analysis || '暂无解析')}</div>
                    </div>
                `;
            } else {
                // 标准题
                contentHTML += `
                    <div class="mt-4">
                        <h4 class="font-bold text-cyan-400 mb-2">答案</h4>
                        <div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(q.answer)}</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-bold text-yellow-400 mb-2">解析</h4>
                        <div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(q.analysis || '暂无解析')}</div>
                    </div>
                `;
            }

            DOMElements.viewModalContent.innerHTML = contentHTML;
            DOMElements.viewQuestionModal.classList.remove('hidden');
        };
        const closeViewModal = () => {
            DOMElements.viewQuestionModal.classList.add('hidden');
        };

        const updateFormUIForType = (type) => {
            const isChoice = ['single-choice', 'multi-choice'].includes(type);
            const isMaterial = type === 'material';
            
            DOMElements.optionsEditor.classList.toggle('hidden', !isChoice);
            DOMElements.subQuestionsEditor.classList.toggle('hidden', !isMaterial);
            DOMElements.standardAnswerEditor.classList.toggle('hidden', isChoice || isMaterial);
        };
        
        const resetModalForNewQuestion = (typeToSet = 'single-choice') => {
            DOMElements.form.reset();
            DOMElements.questionIdInput.value = '';
            DOMElements.modalTitle.textContent = '添加新题目';
            DOMElements.questionTypeSelect.value = typeToSet;
            updateFormUIForType(typeToSet);
            if (['single-choice', 'multi-choice'].includes(typeToSet)) {
                renderOptionsEditor(typeToSet);
            }
            if (typeToSet === 'material'){
                renderSubQuestionsEditor();
            }
            DOMElements.parseStemBtn.classList.add('hidden');
            updatePreview();
            DOMElements.questionStemInput.focus();
        };

        const openModal = (question = null) => {
            if (question) {
                DOMElements.form.reset();
                DOMElements.modalTitle.textContent = '编辑题目';
                DOMElements.questionIdInput.value = question.id;
                DOMElements.questionStemInput.value = question.stem;
                DOMElements.questionAnswerInput.value = question.answer;
                DOMElements.questionAnalysisInput.value = question.analysis;
                DOMElements.questionTagsInput.value = question.tags.join(', ');
                DOMElements.questionTypeSelect.value = question.type;
                updateFormUIForType(question.type);
                if (['single-choice', 'multi-choice'].includes(question.type)) {
                    renderOptionsEditor(question.type, JSON.parse(question.options || '[]'));
                }
                if (question.type === 'material') {
                    renderSubQuestionsEditor(JSON.parse(question.subQuestions || '[]'));
                }
                DOMElements.parseStemBtn.classList.add('hidden');
            } else {
                resetModalForNewQuestion();
            }
            updatePreview();
            DOMElements.modal.classList.remove('hidden');
          	setTimeout(() => {
                DOMElements.questionStemInput.focus();
            }, 50);
        };

        const closeModal = () => DOMElements.modal.classList.add('hidden');
        
        // ========================================================================
        // ======================= 优化后的解析模块 START =======================
        // ========================================================================

        const separateQuestionParts = (rawText) => {
            let text = rawText.replace(/^\s*\d+[\.、\s]*/, '').trim();
            let stem = text, answerPart = '', analysisPart = '';

            const answerMatchIndex = text.indexOf('【答案】');
            const analysisMatchIndex = text.indexOf('【解析】');

            if (answerMatchIndex !== -1 && analysisMatchIndex !== -1) {
                if (answerMatchIndex < analysisMatchIndex) {
                    stem = text.substring(0, answerMatchIndex).trim();
                    answerPart = text.substring(answerMatchIndex + 4, analysisMatchIndex).trim();
                    analysisPart = text.substring(analysisMatchIndex + 4).trim();
                } else {
                    stem = text.substring(0, analysisMatchIndex).trim();
                    analysisPart = text.substring(analysisMatchIndex + 4, answerMatchIndex).trim();
                    answerPart = text.substring(answerMatchIndex + 4).trim();
                }
            } else if (answerMatchIndex !== -1) {
                stem = text.substring(0, answerMatchIndex).trim();
                answerPart = text.substring(answerMatchIndex + 4).trim();
            } else if (analysisMatchIndex !== -1) {
                stem = text.substring(0, analysisMatchIndex).trim();
                analysisPart = text.substring(analysisMatchIndex + 4).trim();
            }
            
            return { stem, answerPart, analysisPart };
        };

        const isMaterialQuestion = (rawText) => {
            const answerCount = (rawText.match(/【答案】/g) || []).length;
            if (answerCount > 1) return true;
            
            const analysisCount = (rawText.match(/【解析】/g) || []).length;
            if (analysisCount > 1) return true;

            const numberedItems = rawText.match(/^\s*(\d+)[\.、\s]/gm) || [];
            const uniqueNumbers = [...new Set(numberedItems.map(item => parseInt(item)))];
            return uniqueNumbers.length > 1;
        };
        
        const isJudgmentQuestion = (stem, answerPart) => {
             const judgmentWords = ["正确", "错误", "对", "错", "×", "✓", "T", "F"];
             const upperAnswer = answerPart.toUpperCase().trim();
             return judgmentWords.some(word => upperAnswer === word);
        };
        
        const cleanAndValidateOptions = (matches) => {
            if (!matches || matches.length === 0) return [];
            
            const options = matches
                .map(match => ({ letter: match[1], text: match[2].trim() }))
                .filter(opt => opt.text && opt.text.length > 0 && opt.text.length < 1500);

            if (options.length < 2) return [];

            const firstCharCode = options[0].letter.charCodeAt(0);
            const isConsecutive = options.every((opt, index) => opt.letter.charCodeAt(0) === firstCharCode + index);

            return isConsecutive ? options : [];
        };

        const extractOptionsFromText = (text) => {
            const multiLinePattern = /([A-Z])\.\s*([\s\S]+?)(?=\s*\n[A-Z]\.|\s*\n【|^\s*【|$)/g;
            const matches = [...text.matchAll(multiLinePattern)];
            const options = cleanAndValidateOptions(matches);
            
            if (options.length >= 2) return options;
            
            const singleLinePattern = /([A-Z])\.\s*([^A-Z\n\r【]+)/g;
            const singleLineMatches = [...text.matchAll(singleLinePattern)];
            return cleanAndValidateOptions(singleLineMatches);
        };

        const parseAsChoiceQuestion = (stem, answerPart, analysisPart, options) => {
            const firstOptionIndex = stem.indexOf(options[0].letter + '.');
            const pureStem = firstOptionIndex > -1 ? stem.substring(0, firstOptionIndex).trim() : stem;
            
            const correctAnswers = answerPart.replace(/[^A-Z]/g, '');
            const newType = correctAnswers.length > 1 ? 'multi-choice' : 'single-choice';
            
            const optionsWithCorrectness = options.map(opt => ({
                text: opt.text,
                isCorrect: correctAnswers.includes(opt.letter)
            }));

            DOMElements.questionStemInput.value = pureStem;
            DOMElements.questionAnalysisInput.value = analysisPart;
            DOMElements.questionTypeSelect.value = newType;
            updateFormUIForType(newType);
            renderOptionsEditor(newType, optionsWithCorrectness);
        };

        const parseAsStandardQuestion = (stem, answerPart, analysisPart) => {
            DOMElements.questionStemInput.value = stem;
            DOMElements.questionAnswerInput.value = answerPart;
            DOMElements.questionAnalysisInput.value = analysisPart;
            DOMElements.questionTypeSelect.value = 'standard';
            updateFormUIForType('standard');
        };

        const parseAndPopulateSubQuestion = (sqNode) => {
            const stemTextarea = sqNode.querySelector('textarea[data-field="stem"]');
            if (!stemTextarea || !stemTextarea.value.trim()) return;

            try {
                const parts = separateQuestionParts(stemTextarea.value);
                const { stem, answerPart, analysisPart } = parts;

                const typeSelect = sqNode.querySelector('.sub-question-type-select');
                const optionsArea = sqNode.querySelector('.sub-question-options-area');
                const answerArea = sqNode.querySelector('.sub-question-answer-area');
                const analysisTextarea = sqNode.querySelector('textarea[data-field="analysis"]');

                analysisTextarea.value = analysisPart;
                
                if (isJudgmentQuestion(stem, answerPart)) {
                    const isCorrect = ["正确", "对", "✓", "T"].some(kw => answerPart.toUpperCase().includes(kw));
                    stemTextarea.value = stem;
                    typeSelect.value = 'single-choice';
                    answerArea.style.display = 'none';
                    optionsArea.style.display = '';
                    optionsArea.innerHTML = '';
                    
                    const options = [{text: '正确', isCorrect: isCorrect}, {text: '错误', isCorrect: !isCorrect}];
                    options.forEach((opt, index) => {
                         const optDiv = document.createElement('div');
                         optDiv.className = 'flex items-center gap-2';
                         optDiv.innerHTML = `
                             <input type="radio" name="sub-question-correct-${sqNode.dataset.sqId}" value="${index}" ${opt.isCorrect ? 'checked' : ''} class="w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded">
                             <input type="text" data-field="option-text" value="${opt.text}" class="flex-1 bg-gray-700 border-gray-600 rounded-md p-1 text-sm">
                             <button type="button" class="remove-sub-option-btn text-red-500 text-xs">&times;</button>`;
                         optionsArea.appendChild(optDiv);
                    });
                } else {
                    const options = extractOptionsFromText(stem);
                    if (options.length >= 2) { // Is a choice question
                        const pureStem = stem.substring(0, stem.indexOf(options[0].letter + '.')).trim();
                        stemTextarea.value = pureStem;
                        
                        const correctAnswers = answerPart.replace(/[^A-Z]/g, '');
                        const newType = correctAnswers.length > 1 ? 'multi-choice' : 'single-choice';
                        typeSelect.value = newType;
                        
                        answerArea.style.display = 'none';
                        optionsArea.style.display = '';
                        optionsArea.innerHTML = '';
                        
                        const inputType = newType === 'single-choice' ? 'radio' : 'checkbox';
                        options.forEach((opt, index) => {
                            const optDiv = document.createElement('div');
                            optDiv.className = 'flex items-center gap-2';
                            optDiv.innerHTML = `
                                <input type="${inputType}" name="sub-question-correct-${sqNode.dataset.sqId}" value="${index}" ${correctAnswers.includes(opt.letter) ? 'checked' : ''} class="w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded">
                                <input type="text" data-field="option-text" value="${opt.text}" class="flex-1 bg-gray-700 border-gray-600 rounded-md p-1 text-sm">
                                <button type="button" class="remove-sub-option-btn text-red-500 text-xs">&times;</button>`;
                            optionsArea.appendChild(optDiv);
                        });
                    } else { // Is a standard question
                        stemTextarea.value = stem;
                        sqNode.querySelector('textarea[data-field="answer"]').value = answerPart;
                        typeSelect.value = 'standard';
                        answerArea.style.display = '';
                        optionsArea.style.display = 'none';
                    }
                }
                 const addOptBtn = document.createElement('button');
                 addOptBtn.type = 'button';
                 addOptBtn.className = 'add-sub-option-btn text-cyan-400 text-xs hover:text-cyan-300 mt-1';
                 addOptBtn.textContent = '+ 添加选项';
                 optionsArea.appendChild(addOptBtn);

            } catch(e) { console.error('子问题解析失败:', e); }
        };

        const parseAsMaterialQuestion = (rawText) => {
            DOMElements.questionTypeSelect.value = 'material';
            updateFormUIForType('material');

            // Split by markers: newline followed by a number
            const subQuestionBlocks = rawText.split(/\n(?=\s*\d+[\.、\s])/)
                .filter(block => block.trim() !== '');

            if (subQuestionBlocks.length === 0) {
                DOMElements.questionStemInput.value = rawText; // Fallback
                return;
            }

            // Heuristic: If the first block does NOT contain 【答案】, it's the main stem.
            let mainStem = '';
            let startIndex = 0;
            if (!subQuestionBlocks[0].includes('【答案】') && !subQuestionBlocks[0].includes('【解析】')) {
                mainStem = subQuestionBlocks[0].trim();
                startIndex = 1;
            }

            DOMElements.questionStemInput.value = mainStem;
            DOMElements.subQuestionsContainer.innerHTML = ''; 

            for (let i = startIndex; i < subQuestionBlocks.length; i++) {
                const blockText = subQuestionBlocks[i];
                const sqNode = createSubQuestionNode({ stem: blockText });
                DOMElements.subQuestionsContainer.appendChild(sqNode);
                parseAndPopulateSubQuestion(sqNode);
            }
            DOMElements.questionAnalysisInput.value = '';
        };

        const parseAndPopulateFields = (rawText) => {
            if (!rawText || !rawText.trim()) return;

            if (!rawText.includes('【答案】') || !rawText.includes('【解析】')) {
                DOMElements.parseStemBtn.classList.remove('hidden');
                DOMElements.questionStemInput.value = rawText;
                updatePreview();
                return;
            } 
            try {
                if (isMaterialQuestion(rawText)) {
                    parseAsMaterialQuestion(rawText);
                } else {
                    const parts = separateQuestionParts(rawText);
                    const { stem, answerPart, analysisPart } = parts;

                    if (isJudgmentQuestion(stem, answerPart)) {
                        const isCorrect = ["正确", "对", "✓", "T"].some(kw => answerPart.toUpperCase().includes(kw));
                        parseAsChoiceQuestion(stem, isCorrect ? 'A' : 'B', analysisPart, [{letter: 'A', text: '正确'}, {letter: 'B', text: '错误'}]);
                    } else {
                        const options = extractOptionsFromText(stem);
                        const answerIsLetters = /^[A-Z]+$/.test(answerPart.trim());

                        if (options.length >= 2 && answerIsLetters) {
                            parseAsChoiceQuestion(stem, answerPart, analysisPart, options);
                        } else {
                            parseAsStandardQuestion(stem, answerPart, analysisPart);
                        }
                    }
                }
                updatePreview();
                // generateAndApplyAutoTags();
            } catch (error) {
                console.error('题目解析过程中发生错误:', error);
            }
        };

        // ======================================================================
        // ======================= 优化后的解析模块 END =========================
        // ======================================================================
        
        const updatePreview = () => {
        const type = DOMElements.questionTypeSelect.value;
        const stem = DOMElements.questionStemInput.value;
        const analysis = DOMElements.questionAnalysisInput.value;
        
        let previewHTML = '<div class="space-y-4">';
        
        // 题干部分
        previewHTML += `<div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(stem)}</div>`;
        
        if (['single-choice', 'multi-choice'].includes(type)) {
            const options = [];
            const correctIndices = [];
            
            DOMElements.optionsContainer.querySelectorAll('.flex.items-center').forEach((div, index) => {
                const text = div.querySelector('input[type="text"]').value;
                const isCorrect = div.querySelector('input[type="radio"], input[type="checkbox"]')?.checked || false;
                
                if(text) {
                    options.push({ text, isCorrect });
                    if(isCorrect) correctIndices.push(index);
                }
            });
            
            if (options.length > 0) {
                // 🔥 选项显示，带高亮效果
                previewHTML += '<div class="mt-3 space-y-2">' + 
                    options.map((opt, idx) => {
                        const letter = String.fromCharCode(65 + idx);
                        const highlightClass = opt.isCorrect 
                            ? 'bg-green-900/40 border border-green-600/50 text-green-300 font-semibold' 
                            : 'bg-gray-800/50';
                        
                        return `<div class="flex gap-2 items-start rounded-md ${highlightClass} transition-all">
                            <span class="flex-shrink-0 pt-0.5">${letter}.</span>
                            <div class="flex-1">${renderMarkdown(opt.text)}</div>
                        </div>`;
                    }).join('') + 
                '</div>';
            }
        } else if (type === 'material') {
            // 🔥 材料题预览子问题
            const subQuestions = [];
            DOMElements.subQuestionsContainer.querySelectorAll('[data-sq-id]').forEach((sqNode, index) => {
                const sqType = sqNode.querySelector('.sub-question-type-select').value;
                const sqStem = sqNode.querySelector('textarea[data-field="stem"]').value.trim();
                
                if (sqStem) {
                    const sq = {
                        type: sqType,
                        stem: sqStem,
                        options: [],
                        correctIndices: []
                    };
                    
                    if (sqType !== 'standard') {
                        const optionDivs = sqNode.querySelectorAll('.sub-question-options-area > .flex');
                        optionDivs.forEach((optDiv, optIdx) => {
                            const optInput = optDiv.querySelector('input[type="text"]');
                            const optCheckbox = optDiv.querySelector('input[type="radio"], input[type="checkbox"]');
                            
                            if (optInput && optInput.value.trim()) {
                                const isCorrect = optCheckbox ? optCheckbox.checked : false;
                                sq.options.push({
                                    text: optInput.value.trim(),
                                    isCorrect
                                });
                                if (isCorrect) {
                                    sq.correctIndices.push(sq.options.length - 1);
                                }
                            }
                        });
                    }
                    
                    subQuestions.push(sq);
                }
            });
            
            if (subQuestions.length > 0) {
                previewHTML += '<div class="mt-4 pt-4 border-t border-gray-700 space-y-4">';
                subQuestions.forEach((sq, index) => {
                    previewHTML += `<div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <div class="font-semibold text-gray-300 mb-2">(${index + 1}) ${renderMarkdown(sq.stem)}</div>`;
                    
                    if (sq.options.length > 0) {
                        previewHTML += '<div class="mt-2 space-y-1.5">' +
                            sq.options.map((opt, optIdx) => {
                                const letter = String.fromCharCode(65 + optIdx);
                                const highlightClass = opt.isCorrect 
                                    ? 'bg-green-900/40 border border-green-600/50 text-green-300 font-semibold' 
                                    : 'bg-gray-800/30';
                                const iconHTML = opt.isCorrect 
                                    ? '<svg class="w-4 h-4 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' 
                                    : '';
                                
                                return `<div class="flex gap-2 items-start p-2 rounded ${highlightClass} text-sm">
                                    <span class="font-semibold text-cyan-400 flex-shrink-0">${letter}.</span>
                                    <div class="flex-1">${renderMarkdown(opt.text)}</div>
                                    ${iconHTML}
                                </div>`;
                            }).join('') +
                        '</div>';
                        
                        // 子问题答案提示
                        if (sq.correctIndices.length > 0) {
                            const answerText = sq.correctIndices.map(idx => String.fromCharCode(65 + idx)).join(', ');
                            previewHTML += `<div class="mt-2 text-sm text-cyan-400">
                                <span class="font-semibold">答案：</span>${answerText}
                            </div>`;
                        }
                    }
                    
                    previewHTML += '</div>';
                });
                previewHTML += '</div>';
            }
        } else {
            // 🔥 标准题显示答案
            const answer = DOMElements.questionAnswerInput.value.trim();
            if (answer) {
                previewHTML += `<div class="mt-3 px-4 py-2 bg-cyan-900/30 border border-cyan-600/30 rounded-lg">
                    <div class="text-cyan-400 font-semibold mb-1">答案：</div>
                    <div class="text-gray-300 prose prose-invert prose-sm">${renderMarkdown(answer)}</div>
                </div>`;
            }
        }
        
        // 🔥 解析部分（所有题型）
        if (analysis && analysis.trim()) {
            previewHTML += `<div class="mt-3 px-4 py-3 bg-yellow-900/20 border border-yellow-600/30 rounded-lg">
                <div class="text-yellow-400 font-semibold mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    解析
                </div>
                <div class="text-gray-300 prose prose-invert prose-sm">${renderMarkdown(analysis)}</div>
            </div>`;
        }
        
        previewHTML += '</div>';
        
        DOMElements.previewArea.innerHTML = previewHTML;
    };
        
        const saveQuestionData = async () => {
            const id = parseInt(DOMElements.questionIdInput.value);
            const type = DOMElements.questionTypeSelect.value;
            
            const questionData = {
                type: type,
                stem: DOMElements.questionStemInput.value.trim(),
                analysis: DOMElements.questionAnalysisInput.value.trim(),
                tags: DOMElements.questionTagsInput.value.split(/,|，/).map(t => t.trim()).filter(Boolean),
                updatedAt: new Date(),
            };

            if (!questionData.stem && type !== 'material') {
                alert("题干不能为空！");
                return;
            }

            if (['single-choice', 'multi-choice'].includes(type)) {
                const options = [];
                let hasCorrect = false;
                let correctIndices = [];

                DOMElements.optionsContainer.querySelectorAll('.flex.items-center').forEach((div, index) => {
                    const textInput = div.querySelector('input[type="text"]');
                    const isCorrectInput = div.querySelector('input[type="radio"], input[type="checkbox"]');
                    if(textInput && isCorrectInput && textInput.value.trim()){
                        const isCorrect = isCorrectInput.checked;
                        options.push({ text: textInput.value.trim(), isCorrect });
                        if (isCorrect) {
                            hasCorrect = true;
                            correctIndices.push(index);
                        }
                    }
                });

                if (options.length < 2) {
                    alert("选择题必须至少有两个选项！");
                    return;
                }
                if (!hasCorrect) {
                    alert("选择题必须至少有一个正确答案！");
                    return;
                }

                questionData.options = JSON.stringify(options);
                questionData.answer = correctIndices.map(idx => String.fromCharCode(65 + idx)).join(', ');

            } else if (type === 'material') {
                const subQuestions = [];
                let validationFailed = false;
                DOMElements.subQuestionsContainer.querySelectorAll('[data-sq-id]').forEach(sqNode => {
                    if (validationFailed) return;

                    const sqType = sqNode.querySelector('.sub-question-type-select').value;
                    const sqStem = sqNode.querySelector('textarea[data-field="stem"]').value.trim();
                    
                    if (!sqStem) {
                        alert("子问题题干不能为空！");
                        validationFailed = true;
                        return;
                    }

                    const sq = {
                        id: sqNode.dataset.sqId,
                        type: sqType,
                        stem: sqStem,
                        analysis: sqNode.querySelector('textarea[data-field="analysis"]').value.trim(),
                        answer: '',
                        options: []
                    };

                    if (sqType !== 'standard') {
                        const optionDivs = sqNode.querySelectorAll('.sub-question-options-area > .flex');
                        let sqHasCorrect = false;
                        let sqCorrectIndices = [];

                        optionDivs.forEach((optDiv, optIdx) => {
                            const optInput = optDiv.querySelector('input[type="text"]');
                            const optCheckbox = optDiv.querySelector('input[type="radio"], input[type="checkbox"]');
                            
                            if (optInput && optInput.value.trim()) {
                                const isCorrect = optCheckbox ? optCheckbox.checked : false;
                                sq.options.push({ text: optInput.value.trim(), isCorrect });
                                if (isCorrect) {
                                    sqHasCorrect = true;
                                    sqCorrectIndices.push(sq.options.length - 1);
                                }
                            }
                        });
                        if (sq.options.length > 0 && !sqHasCorrect) {
                           alert(`子问题 "${sq.stem.substring(0, 20)}..." 必须至少有一个正确答案！`);
                           validationFailed = true;
                           return;
                        }
                        sq.answer = sqCorrectIndices.map(idx => String.fromCharCode(65 + idx)).join(', ');
                    } else {
                        sq.answer = sqNode.querySelector('textarea[data-field="answer"]')?.value.trim() || '';
                    }
                    subQuestions.push(sq);
                });
                if(validationFailed) return;

                if (subQuestions.length === 0) {
                    alert("材料题必须至少有一个子问题！");
                    return;
                }
                questionData.subQuestions = JSON.stringify(subQuestions);
                questionData.answer = '见子问题解析';
            } else {
                questionData.answer = DOMElements.questionAnswerInput.value.trim();
                 if (!questionData.answer) {
                    alert("答案不能为空！");
                    return;
                }
            }

            if (id) {
                await db.questions.update(id, questionData);
            } else {
                questionData.createdAt = new Date();
                questionData.reviewStatus = 'new';
                await db.questions.add(questionData);
            }
            return true;
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const success = await saveQuestionData();
            if (success) {
                closeModal();
                await fetchAndRender();
            }
        };
        
        // --- 快捷键支持 ---
        DOMElements.modal.addEventListener('keydown', (e) => {
            // Cmd+Enter (Mac) 或 Ctrl+Enter (Windows/Linux)
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                
                // 检查模态框是否打开
                if (!DOMElements.modal.classList.contains('hidden')) {
                    triggerHapticFeedback();
                    
                    // 触发保存并继续添加
                    const currentType = DOMElements.questionTypeSelect.value;
                    saveQuestionData().then(success => {
                        if (success) {
                            resetModalForNewQuestion(currentType);
                            fetchAndRender();
                        }
                    });
                }
            }
            
            // Esc 关闭模态框
            if (e.key === 'Escape') {
                if (!DOMElements.modal.classList.contains('hidden')) {
                    e.preventDefault();
                    closeModal();
                }
            }
        });
        DOMElements.saveAndAddAnotherBtn.addEventListener('click', async () => {
            triggerHapticFeedback();
            const currentType = DOMElements.questionTypeSelect.value;
            const success = await saveQuestionData();
            if (success) {
                resetModalForNewQuestion(currentType);
                await fetchAndRender();
            }
        });

        // --- 9. EVENT LISTENERS (DYNAMIC & DELEGATED) ---
        DOMElements.subQuestionsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-sub-question-btn')) {
                e.target.closest('[data-sq-id]').remove();
            }
            if (e.target.classList.contains('add-sub-option-btn')) {
                const sqId = e.target.closest('[data-sq-id]').dataset.sqId;
                const type = e.target.closest('[data-sq-id]').querySelector('.sub-question-type-select').value;
                const inputType = type === 'single-choice' ? 'radio' : 'checkbox';
                const optDiv = document.createElement('div');
                optDiv.className = 'flex items-center gap-2';
                optDiv.innerHTML = `
                    <input type="${inputType}" name="sub-question-correct-${sqId}" class="w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded">
                    <input type="text" data-field="option-text" placeholder="选项内容" class="flex-1 bg-gray-700 border-gray-600 rounded-md p-1 text-sm">
                    <button type="button" class="remove-sub-option-btn text-red-500 hover:text-red-400 text-xs">&times;</button>
                `;
                e.target.before(optDiv);
            }
            if (e.target.classList.contains('remove-sub-option-btn')) {
                e.target.closest('.flex').remove();
            }
        });

        DOMElements.subQuestionsContainer.addEventListener('change', e => {
            if (e.target.classList.contains('sub-question-type-select')) {
                const sqNode = e.target.closest('[data-sq-id]');
                const type = e.target.value;
                sqNode.querySelector('.sub-question-answer-area').style.display = type === 'standard' ? '' : 'none';
                const optionsArea = sqNode.querySelector('.sub-question-options-area');
                optionsArea.style.display = type !== 'standard' ? '' : 'none';
                if (type !== 'standard' && !optionsArea.querySelector('.add-sub-option-btn')) {
                    optionsArea.innerHTML = '';
                    const addOptBtn = document.createElement('button');
                    addOptBtn.type = 'button';
                    addOptBtn.className = 'add-sub-option-btn text-cyan-400 text-xs hover:text-cyan-300 mt-1';
                    addOptBtn.textContent = '+ 添加选项';
                    optionsArea.appendChild(addOptBtn);
                }
            }
        });
        
        // --- 10. EVENT LISTENERS (STATIC) ---

        DOMElements.parseStemBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            const rawText = DOMElements.questionStemInput.value;
            // 重新运行解析逻辑
            parseAndPopulateFields(rawText); 
            DOMElements.parseStemBtn.classList.add('hidden');
        });

        const openAddModal = () => {
            triggerHapticFeedback();
            openModal();
        }
        DOMElements.addBtn.addEventListener('click', openAddModal);
        DOMElements.mobileAddBtn.addEventListener('click', openAddModal);

        DOMElements.cancelBtn.addEventListener('click', closeModal);
        DOMElements.modal.addEventListener('click', (e) => { if (e.target === DOMElements.modal) closeModal(); });
        DOMElements.form.addEventListener('submit', handleFormSubmit);
        DOMElements.questionTypeSelect.addEventListener('change', (e) => {
            const type = e.target.value;
            updateFormUIForType(type);
            if(['single-choice', 'multi-choice'].includes(type) && DOMElements.optionsContainer.children.length === 0) {
                 renderOptionsEditor(type, [{text: '', isCorrect: false}]);
            }
             if(type === 'material' && DOMElements.subQuestionsContainer.children.length === 0) {
                renderSubQuestionsEditor();
            }
            updatePreview();
        });

        const debouncedPreviewUpdate = debounce(updatePreview, 300);
        DOMElements.form.addEventListener('input', (e) => {
             // Only update preview on input, do not re-parse
            if (e.target.matches('#question-stem, #options-container input, #question-answer, #question-analysis, #sub-questions-container textarea, #sub-questions-container input')) {
                debouncedPreviewUpdate();
            }
        });

        let isTagsExpanded = false;
        DOMElements.toggleTagsBtn.addEventListener('click', () => {
            isTagsExpanded = !isTagsExpanded;
            if (isTagsExpanded) {
                DOMElements.filterTagsContainer.classList.remove('max-h-12');
                DOMElements.filterTagsContainer.classList.add('max-h-96'); // 限制一个最大高度
                DOMElements.toggleTagsBtn.textContent = '收起';
            } else {
                DOMElements.filterTagsContainer.classList.add('max-h-12');
                DOMElements.filterTagsContainer.classList.remove('max-h-96');
                DOMElements.toggleTagsBtn.textContent = '显示更多';
            }
        });
        
        // FIX: Changed trigger to 'paste' and simplified logic
        const handlePasteForParsing = (event) => {
            if (DOMElements.questionIdInput.value) return; // Don't parse when editing

            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            const textarea = event.target;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.setRangeText(pastedText, start, end, 'end');

            parseAndPopulateFields(textarea.value);
        };
        DOMElements.questionStemInput.addEventListener('paste', handlePasteForParsing);
        DOMElements.subQuestionsContainer.addEventListener('paste', (event) => {
             if (event.target.tagName === 'TEXTAREA') {
                const sqNode = event.target.closest('[data-sq-id]');
                 event.preventDefault();
                 const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                 const textarea = event.target;
                 const start = textarea.selectionStart;
                 const end = textarea.selectionEnd;
                 textarea.setRangeText(pastedText, start, end, 'end');
                 if(sqNode) {
                    parseAndPopulateSubQuestion(sqNode);
                 }
             }
        });
        DOMElements.pasteAndParseBtn.addEventListener('click', async () => {
            if (!navigator.clipboard || !navigator.clipboard.readText) {
                alert('您的浏览器不支持自动粘贴功能。请长按输入框手动粘贴。');
                return;
            }
            
            try {
                const pastedText = await navigator.clipboard.readText();
                if (pastedText && pastedText.trim()) {
                    triggerHapticFeedback(); // 触发震动反馈
                    DOMElements.questionStemInput.value = pastedText;
                    
                    // 调用现有的核心解析函数
                    parseAndPopulateFields(pastedText);
                }
            } catch (err) {
                console.error('无法读取粘贴板:', err);
                alert('无法读取粘贴板。请确保已授予权限，或尝试手动粘贴。');
            }
        });


        DOMElements.form.addEventListener('click', e => {
            const button = e.target.closest('button[data-md]');
            if (!button) return;

            e.preventDefault();
            const mdType = button.dataset.md;
            const toolbar = button.closest('.markdown-toolbar');
            const textarea = toolbar ? toolbar.nextElementSibling : null;
            if (!textarea || textarea.tagName !== 'TEXTAREA') return;

            switch(mdType) {
                case 'bold': applyMarkdown(textarea, '**'); break;
                case 'italic': applyMarkdown(textarea, '*'); break;
                case 'strike': applyMarkdown(textarea, '~~'); break;
                case 'code': applyMarkdown(textarea, '`'); break;
                case 'katex': applyMarkdown(textarea, '$'); break;
                case 'katex-block': applyMarkdown(textarea, '$$'); break;
                case 'textcolor': {
                    const colorInput = toolbar.querySelector('input[data-for="textcolor"]');
                    if (colorInput) applyStyleSpan(textarea, 'color', colorInput.value);
                    break;
                }
                case 'bgcolor': {
                    const colorInput = toolbar.querySelector('input[data-for="bgcolor"]');
                    if (colorInput) applyStyleSpan(textarea, 'background-color', colorInput.value);
                    break;
                }
            }
        });
        
        DOMElements.addOptionBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            const type = DOMElements.questionTypeSelect.value;
            const inputType = type === 'single-choice' ? 'radio' : 'checkbox';
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="${inputType}" name="option-correct" class="w-4 h-4 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500">
                <input type="text" placeholder="选项内容" class="flex-1 bg-gray-700 border-gray-600 rounded-md p-2 text-white">
                <button type="button" class="remove-option-btn text-red-500 hover:text-red-400">&times;</button>
            `;
            DOMElements.optionsContainer.appendChild(div);
        });
        
        DOMElements.optionsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-option-btn')) {
                e.target.closest('.flex').remove();
            }
        });

        DOMElements.addSubQuestionBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            DOMElements.subQuestionsContainer.appendChild(createSubQuestionNode());
        });

        const debouncedSearch = debounce(() => {
            state.pagination.currentPage = 1;
            renderAllQuestions();
        }, 300);
        DOMElements.searchBox.addEventListener('input', (e) => {
            state.filters.search = e.target.value.toLowerCase();
            debouncedSearch();
        });
        
        DOMElements.grid.addEventListener('click', async (e) => {
            const card = e.target.closest('[data-id]');
            if (!card) return;
            const id = parseInt(card.dataset.id);

            const buttonClicked = e.target.closest('button');
            if(buttonClicked) triggerHapticFeedback();

            if (e.target.closest('.edit-btn')) {
                e.stopPropagation();
                const question = await db.questions.get(id);
                openModal(question);
                return;
            }

            if (e.target.closest('.delete-btn')) {
                e.stopPropagation();
                showConfirmation('确认删除?', '此操作将永久删除该题目。', async () => {
                    await db.questions.delete(id);
                    await fetchAndRender();
                });
                return;
            }
            
            if (e.target.closest('.expand-btn')) {
                e.stopPropagation();
                const previewDiv = card.querySelector('.sub-questions-preview');
                const isHidden = previewDiv.classList.contains('hidden');
                if (isHidden && previewDiv.innerHTML === '') {
                    const question = await db.questions.get(id);
                    const subQs = JSON.parse(question.subQuestions || '[]');
                    previewDiv.innerHTML = subQs.map((sq, i) => `<p><strong class="mr-2">${i+1}.</strong>${sq.stem}</p>`).join('');
                }
                previewDiv.classList.toggle('hidden');
                e.target.textContent = isHidden ? '收起子问题' : `展开 ${JSON.parse((await db.questions.get(id)).subQuestions).length} 个子问题`;
                return;
            }

            openViewModal(id);
        });

        DOMElements.filterTagsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                triggerHapticFeedback();
                const tag = e.target.dataset.tag;
                const tagIndex = state.filters.tags.indexOf(tag);
                if (tagIndex > -1) state.filters.tags.splice(tagIndex, 1);
                else state.filters.tags.push(tag);
                
                state.pagination.currentPage = 1;
                renderAllQuestions();
                renderTagsForFiltering();
            }
        });

        // --- 10.1. PAGINATION EVENT LISTENERS ---
        DOMElements.pageSizeSelect.addEventListener('change', (e) => {
            state.pagination.pageSize = parseInt(e.target.value);
            state.pagination.currentPage = 1;
            renderAllQuestions();
        });
        const navigatePage = (page) => {
            if (page >= 1 && page !== state.pagination.currentPage) {
                const totalItems = getFilteredQuestions().length;
                const totalPages = Math.ceil(totalItems / state.pagination.pageSize);
                if(page > totalPages) return;

                 triggerHapticFeedback();
                 state.pagination.currentPage = page;
                 renderAllQuestions();
            }
        }
        DOMElements.firstPageBtn.addEventListener('click', () => navigatePage(1));
        DOMElements.prevPageBtn.addEventListener('click', () => navigatePage(state.pagination.currentPage - 1));
        DOMElements.nextPageBtn.addEventListener('click', () => navigatePage(state.pagination.currentPage + 1));
        DOMElements.lastPageBtn.addEventListener('click', () => {
             const totalItems = getFilteredQuestions().length;
             const totalPages = Math.ceil(totalItems / state.pagination.pageSize);
             navigatePage(totalPages);
        });
        DOMElements.pageNumbers.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.page) {
                navigatePage(parseInt(e.target.dataset.page));
            }
        });
        
        // --- 11. PRACTICE MODE LOGIC ---
        const startPractice = (mode = 'smart', limit = 20) => {
            triggerHapticFeedback();
            const filteredQuestions = getFilteredQuestions();
            
            let practiceQueue = [];

            // 1. 根据模式构建练习队列
            if (mode === 'smart') {
                const priorityQueue = filteredQuestions.filter(q => q.reviewStatus === 'new' || q.reviewStatus === 'reviewing');
                const masteredQueue = filteredQuestions.filter(q => q.reviewStatus === 'mastered');
                const shuffledPriority = shuffleArray(priorityQueue);
                const shuffledMastered = shuffleArray(masteredQueue);
                // 优先练习新题/错题，然后复习已掌握的
                practiceQueue = [...shuffledPriority, ...shuffledMastered];
            } else if (mode === 'mistakes') {
                const priorityQueue = filteredQuestions.filter(q => q.reviewStatus === 'new' || q.reviewStatus === 'reviewing');
                practiceQueue = shuffleArray(priorityQueue);
            } else { // 'random'
                practiceQueue = shuffleArray(filteredQuestions);
            }

            // 2. 应用题量限制
            state.practice.questions = practiceQueue.slice(0, limit);

            // 3. 开始练习
            state.practice.currentIndex = 0;
            if (state.practice.questions.length > 0) {
                DOMElements.practiceModal.classList.add('flex');
                DOMElements.practiceModal.classList.remove('hidden');
                loadPracticeQuestion();
            } else {
                // 如果队列为空，给用户提示
                alert("没有符合条件的题目可供练习！");
            }
        };
const openPracticeOptionsModal = () => {
            const filteredQuestions = getFilteredQuestions();
            const totalCount = filteredQuestions.length;

            if (totalCount === 0) {
                alert("题库中没有题目，请先添加。");
                return;
            }

            // 更新题量显示
            DOMElements.practiceLimitLabel.textContent = `/ 共 ${totalCount} 题`;
            DOMElements.practiceLimitInput.max = totalCount;

            // 如果默认题量(20)超过了总数，则使用总数作为默认值
            if (parseInt(DOMElements.practiceLimitInput.value) > totalCount) {
                DOMElements.practiceLimitInput.value = totalCount;
            }
            
            // 总是重置为默认的“智能练习”模式
            DOMElements.practiceModeGroup.querySelector('input[value="smart"]').checked = true;

            // 显示模态框
            DOMElements.practiceOptionsModal.classList.remove('hidden');
        };

        const setupScrollSpy = () => {
             if (state.practice.intersectionObserver) {
                state.practice.intersectionObserver.disconnect();
            }
            const options = {
                root: DOMElements.practiceSubQuestionsArea,
                rootMargin: '0px',
                threshold: 0.5 
            };
            const callback = (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const index = entry.target.dataset.sqIndex;
                        DOMElements.practiceNavigator.querySelectorAll('.navigator-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.index === index);
                        });
                    }
                });
            };
            state.practice.intersectionObserver = new IntersectionObserver(callback, options);
            DOMElements.practiceSubQuestionsArea.querySelectorAll('[data-sq-index]').forEach(el => {
                state.practice.intersectionObserver.observe(el);
            });
        };

        const loadPracticeQuestion = () => {
            DOMElements.practiceFeedbackArea.innerHTML = '';
            const q = state.practice.questions[state.practice.currentIndex];
            const questionTypeMap = {
                'standard': '标准题',
                'single-choice': '单选题',
                'multi-choice': '多选题',
                'material': '材料题'
            };
            // 更新题型显示
            DOMElements.practiceQuestionType.textContent = questionTypeMap[q.type] || '未知题型';
            DOMElements.practiceProgress.textContent = `${state.practice.currentIndex + 1} / ${state.practice.questions.length}`;
            DOMElements.practiceAnswerArea.classList.add('hidden');
            DOMElements.reviewButtons.classList.add('hidden');
            DOMElements.practiceSubQuestionsArea.innerHTML = '';
            DOMElements.practiceNavigator.innerHTML = '';

            DOMElements.mobilePracticeTabs.classList.add('hidden');
            DOMElements.practiceMaterialPane.classList.add('hidden');
            DOMElements.practiceQuestionsPane.classList.add('hidden');

            if (q.type === 'material') {
                DOMElements.mobilePracticeTabs.classList.remove('hidden');
                DOMElements.practiceMaterialPane.classList.remove('hidden');
                DOMElements.practiceQuestionsPane.classList.remove('hidden');
                document.querySelector('.mobile-practice-tab[data-tab="material"]').click();

                DOMElements.practiceStemContent.innerHTML = renderMarkdown(q.stem);
                DOMElements.checkAnswerBtn.classList.remove('hidden');
                DOMElements.showAnswerBtn.classList.add('hidden');
                
                const subQs = JSON.parse(q.subQuestions || '[]');
                subQs.forEach((sq, index) => {
                    const navBtn = document.createElement('button');
                    navBtn.className = 'navigator-btn w-8 h-8 rounded-md bg-gray-700 hover:bg-gray-600 transition';
                    navBtn.textContent = index + 1;
                    navBtn.dataset.index = index;
                    navBtn.onclick = () => {
                         DOMElements.practiceSubQuestionsArea.querySelector(`[data-sq-index="${index}"]`).scrollIntoView({ behavior: 'smooth' });
                    };
                    DOMElements.practiceNavigator.appendChild(navBtn);
                    
                    const sqDiv = document.createElement('div');
                    sqDiv.className = 'p-4 bg-gray-700/50 rounded-lg';
                    sqDiv.dataset.sqIndex = index;
                    let optionsHTML = '';
                    if (sq.type !== 'standard') {
                        const inputType = sq.type === 'single-choice' ? 'radio' : 'checkbox';
                        optionsHTML = (sq.options || []).map((opt, optIndex) => `
                            <div class="option-input-group">
                                <input type="${inputType}" name="practice-sq-option-${index}" id="practice-sq-${index}-opt-${optIndex}" value="${optIndex}" data-sq-index="${index}">
                                <label for="practice-sq-${index}-opt-${optIndex}" class="block w-full p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer transition">${renderMarkdown(opt.text)}</label>
                            </div>
                        `).join('');
                    }
                    sqDiv.innerHTML = `
                        <div class="prose prose-invert max-w-none mb-3">${renderMarkdown(`**(${index + 1})** ${sq.stem}`)}</div>
                        <div class="space-y-3">${optionsHTML}</div>
                        <div class="practice-sq-feedback text-sm mt-2"></div>
                    `;
                    DOMElements.practiceSubQuestionsArea.appendChild(sqDiv);
                });
                setupScrollSpy();

            } else {
                DOMElements.practiceMaterialPane.classList.remove('hidden');
                DOMElements.practiceStemContent.innerHTML = renderMarkdown(q.stem);
                
                if (['single-choice', 'multi-choice'].includes(q.type)) {
                    DOMElements.checkAnswerBtn.classList.remove('hidden');
                    DOMElements.showAnswerBtn.classList.add('hidden');
                    const options = JSON.parse(q.options || '[]');
                    const inputType = q.type === 'single-choice' ? 'radio' : 'checkbox';
                    const optionsHTML = options.map((opt, index) => `
                        <div class="option-input-group">
                            <input type="${inputType}" name="practice-option" id="practice-option-${index}" value="${index}">
                            <label for="practice-option-${index}" class="block w-full p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer transition">${renderMarkdown(opt.text)}</label>
                        </div>
                    `).join('');
                    DOMElements.practiceSubQuestionsArea.innerHTML = `<div class="space-y-3">${optionsHTML}</div>`;
                    DOMElements.practiceQuestionsPane.classList.remove('hidden');
                } else {
                    DOMElements.checkAnswerBtn.classList.add('hidden');
                    DOMElements.showAnswerBtn.classList.remove('hidden');
                }
            }
        };
        
        const checkPracticeAnswer = () => {
            triggerHapticFeedback();
            const q = state.practice.questions[state.practice.currentIndex];
            // 禁用所有选项输入
            DOMElements.practiceSubQuestionsArea.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.disabled = true);
            DOMElements.checkAnswerBtn.classList.add('hidden');
            DOMElements.reviewButtons.classList.remove('hidden');

            if (q.type === 'material') {
                const subQs = JSON.parse(q.subQuestions || '[]');
                subQs.forEach((sq, index) => {
                    const sqDiv = DOMElements.practiceSubQuestionsArea.querySelector(`[data-sq-index="${index}"]`);
                    const feedbackDiv = sqDiv.querySelector('.practice-sq-feedback');
                    let isCorrect = false;

                    if (sq.type !== 'standard') {
                        const selectedIndexes = [...sqDiv.querySelectorAll(`input[name="practice-sq-option-${index}"]:checked`)].map(el => parseInt(el.value));
                        const correctIndexes = (sq.options || []).map((o, i) => o.isCorrect ? i : -1).filter(i => i !== -1);
                        isCorrect = selectedIndexes.length === correctIndexes.length && selectedIndexes.every(idx => correctIndexes.includes(idx));
                        
                        let feedbackHTML = isCorrect
                            ? `<p class="text-green-400 font-bold">回答正确</p>`
                            : `<p class="text-red-400 font-bold">回答错误。正确答案: ${sq.options.filter(o => o.isCorrect).map((o, i) => String.fromCharCode(65 + (sq.options.findIndex(opt => opt.text === o.text)))).join('')}</p>`;
                        
                        if (sq.analysis) {
                            feedbackHTML += `<div class="mt-2 text-left text-gray-400 p-2 bg-gray-800 rounded">${renderMarkdown(sq.analysis)}</div>`;
                        }
                        feedbackDiv.innerHTML = feedbackHTML;

                        sqDiv.querySelectorAll('label').forEach((label, labelIndex) => {
                            const input = document.getElementById(`practice-sq-${index}-opt-${labelIndex}`);
                            if(correctIndexes.includes(labelIndex)) {
                                label.classList.add('practice-option-correct');
                            }
                            if(input.checked && !correctIndexes.includes(labelIndex)) {
                                label.classList.add('practice-option-incorrect');
                            }
                        });
                    } else {
                       let feedbackHTML = `<p class="text-cyan-400">参考答案: ${sq.answer}</p>`;
                       if (sq.analysis) {
                            feedbackHTML += `<div class="mt-2 text-left text-gray-400 text-xs p-2 bg-gray-800 rounded">${renderMarkdown(sq.analysis)}</div>`;
                        }
                       feedbackDiv.innerHTML = feedbackHTML;
                    }
                    const navBtn = DOMElements.practiceNavigator.querySelector(`[data-index="${index}"]`);
                    navBtn.classList.add(isCorrect ? 'correct' : 'incorrect');
                });

            } else if (['single-choice', 'multi-choice'].includes(q.type)) {
                const options = JSON.parse(q.options);
                const selectedIndexes = [...DOMElements.practiceSubQuestionsArea.querySelectorAll('input:checked')].map(el => parseInt(el.value));
                const correctIndexes = options.map((o, i) => o.isCorrect ? i : -1).filter(i => i !== -1);
                const isCorrect = selectedIndexes.length === correctIndexes.length && selectedIndexes.every(idx => correctIndexes.includes(idx));

                DOMElements.practiceFeedbackArea.innerHTML = isCorrect
                    ? `<p class="text-green-400 font-bold text-lg">回答正确!</p>`
                    : `<p class="text-red-400 font-bold">回答错误。正确答案: ${options.filter(o => o.isCorrect).map(o => o.text).join(', ')}</p>`;
                
                DOMElements.practiceAnswerArea.innerHTML = `<h4 class="font-bold text-yellow-400 mt-4 mb-2">解析</h4><div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(q.analysis || '暂无解析')}</div>`;
                DOMElements.practiceAnswerArea.classList.remove('hidden');
            }
        };
        const endPractice = () => {
            if (state.practice.intersectionObserver) state.practice.intersectionObserver.disconnect();
            DOMElements.practiceModal.classList.add('hidden');
            DOMElements.practiceModal.classList.remove('flex');
            fetchAndRender();
        };

        DOMElements.startPracticeBtn.addEventListener('click', openPracticeOptionsModal);
        DOMElements.mobilePracticeBtn.addEventListener('click', openPracticeOptionsModal);
        // --- “练习设置”模态框的监听器 ---
        const closePracticeOptionsModal = () => DOMElements.practiceOptionsModal.classList.add('hidden');

        DOMElements.practiceOptionsCloseBtn.addEventListener('click', closePracticeOptionsModal);
        DOMElements.practiceOptionsCancelBtn.addEventListener('click', closePracticeOptionsModal);
        DOMElements.practiceOptionsModal.addEventListener('click', (e) => {
             if (e.target === DOMElements.practiceOptionsModal) closePracticeOptionsModal();
        });

        DOMElements.practiceOptionsStartBtn.addEventListener('click', () => {
            // 1. 获取用户的选择
            const mode = DOMElements.practiceModeGroup.querySelector('input[name="practice-mode"]:checked').value;
            const limit = parseInt(DOMElements.practiceLimitInput.value) || 20;
            
            // 2. 关闭设置模态框
            closePracticeOptionsModal();
            
            // 3. 调用重构后的 startPractice 函数
            // (使用 setTimeout 确保模态框关闭动画更流畅)
            setTimeout(() => {
                startPractice(mode, limit);
            }, 100); 
        });
        DOMElements.closePracticeBtn.addEventListener('click', endPractice);
        DOMElements.checkAnswerBtn.addEventListener('click', checkPracticeAnswer);
        DOMElements.showAnswerBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            
            DOMElements.practiceAnswerArea.innerHTML = `<h4 class="font-bold text-cyan-400 mb-2">答案</h4><div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(state.practice.questions[state.practice.currentIndex].answer)}</div><h4 class="font-bold text-yellow-400 mt-4 mb-2">解析</h4><div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(state.practice.questions[state.practice.currentIndex].analysis || '暂无解析')}</div>`;
            DOMElements.practiceAnswerArea.classList.remove('hidden');
            DOMElements.showAnswerBtn.classList.add('hidden');
            DOMElements.reviewButtons.classList.remove('hidden');
        });

        DOMElements.reviewButtons.addEventListener('click', async (e) => {
            const button = e.target.closest('.review-btn');
            if (!button) return;
            triggerHapticFeedback();
            const status = button.dataset.status;
            const currentQuestion = state.practice.questions[state.practice.currentIndex];
            const newPracticeCount = (currentQuestion.practiceCount || 0) + 1;
            const newErrorCount = (currentQuestion.errorCount || 0) + (state.practice.lastAnswerWasCorrect === false ? 1 : 0);
            await db.questions.update(currentQuestion.id, { reviewStatus: status, practiceCount: newPracticeCount, errorCount: newErrorCount });
            state.practice.currentIndex++;
            if (state.practice.currentIndex < state.practice.questions.length) {
                loadPracticeQuestion();
            } else {
                endPractice();
            }
        });
        
        DOMElements.practiceSubQuestionsArea.addEventListener('change', (e) => {
            if (e.target.matches('input[type="radio"], input[type="checkbox"]')) {
                const sqIndex = e.target.dataset.sqIndex;
                if (sqIndex) {
                    const navBtn = DOMElements.practiceNavigator.querySelector(`[data-index="${sqIndex}"]`);
                    navBtn.classList.add('answered');
                }
            }
        });
        
        DOMElements.mobilePracticeTabs.addEventListener('click', (e) => {
            const button = e.target.closest('.mobile-practice-tab');
            if (!button) return;
            const tab = button.dataset.tab;

            DOMElements.mobilePracticeTabs.querySelectorAll('.mobile-practice-tab').forEach(t => t.classList.remove('active'));
            button.classList.add('active');
            
            document.querySelectorAll('.practice-tab-content').forEach(p => p.classList.add('hidden'));
            if (tab === 'material') {
                DOMElements.practiceMaterialPane.classList.remove('hidden');
            } else {
                 DOMElements.practiceQuestionsPane.classList.remove('hidden');
            }
        });


        // --- 12. CONFIRMATION MODAL LOGIC ---
        const showConfirmation = (title, message, onConfirm) => {
            DOMElements.confirmModal.querySelector('#confirm-title').textContent = title;
            DOMElements.confirmModal.querySelector('#confirm-message').textContent = message;
            DOMElements.confirmModal.classList.remove('hidden');
            DOMElements.confirmOkBtn.onclick = () => {
                triggerHapticFeedback();
                onConfirm();
                hideConfirmation();
            };
        };
        const hideConfirmation = () => DOMElements.confirmModal.classList.add('hidden');
        DOMElements.confirmCancelBtn.addEventListener('click', hideConfirmation);
        DOMElements.confirmModal.addEventListener('click', (e) => { if (e.target === DOMElements.confirmModal) hideConfirmation(); });

        DOMElements.viewModalCloseBtn.addEventListener('click', closeViewModal);
        DOMElements.viewQuestionModal.addEventListener('click', (e) => {
            if (e.target === DOMElements.viewQuestionModal) {
                closeViewModal();
            }
        });

        // --- 13. IMPORT/EXPORT & TEMPLATE LOGIC ---
        const openIOModal = () => {
            triggerHapticFeedback();
            DOMElements.ioModal.classList.remove('hidden');
        }
        const closeIOModal = () => DOMElements.ioModal.classList.add('hidden');
        DOMElements.ioBtn.addEventListener('click', openIOModal);
        DOMElements.mobileIoBtn.addEventListener('click', openIOModal);
        DOMElements.ioCloseBtn.addEventListener('click', closeIOModal);
        DOMElements.ioModal.addEventListener('click', (e) => {
            if (e.target === DOMElements.ioModal) {
                closeIOModal();
            }
        });
        
        DOMElements.deleteAllQuestionsBtn.addEventListener('click', () => {
            closeIOModal();
            setTimeout(() => {
                showConfirmation(
                    '确认删除所有题目?',
                    '此操作将永久清空您的题库，且无法恢复。请谨慎操作！',
                    async () => {
                        try {
                            await db.questions.clear();
                            alert('所有题目已删除');
                            await fetchAndRender();
                        } catch (error) {
                            alert('删除失败: ' + error.message);
                        }
                    }
                );
            }, 200);
        });
        
        const parseDocxContent = (text) => {
            const questions = [];
            const normalizedText = text.replace(/\r\n/g, '\n').replace(/(\s*\n\s*){2,}/g, '\n\n').trim();
            const sections = normalizedText.split(/^[一二三四五六七八九十]+、.+题\s*$/m);
            const titles = normalizedText.match(/^[一二三四五六七八九十]+、.+题\s*$/gm);

            if (!titles) {
                console.error("Could not find any section titles like '一、单项选择题'.");
                return [];
            }
            
            titles.forEach((title, index) => {
                const sectionContent = sections[index + 1];
                if (!sectionContent || !sectionContent.trim()) return;

                let questionType = 'standard';
                if (title.includes('单项选择')) questionType = 'single-choice';
                if (title.includes('多项选择')) questionType = 'multi-choice';
                if (title.includes('判断')) questionType = 'judgment';
                
                const questionBlocks = sectionContent.trim().split(/\n(?=\d+\.)/);

                questionBlocks.forEach(block => {
                    if (!block.trim()) return;

                    const q = {
                        type: questionType, reviewStatus: 'new', createdAt: new Date(), updatedAt: new Date(),
                        tags: [], options: null, subQuestions: null
                    };

                    const answerMatch = block.match(/【答案】\s*([^\n]+)/);
                    const analysisMatch = block.match(/【解析】\s*([\s\S]+)/);
                    const answer = answerMatch ? answerMatch[1].trim() : '';
                    q.analysis = analysisMatch ? analysisMatch[1].trim() : '';
                    
                    let stem = block.replace(/【答案】[^\n]+/, '').replace(/【解析】[\s\S]+/, '').trim();

                    if (questionType === 'single-choice' || questionType === 'multi-choice') {
                        const optionsArray = [];
                        const optionLines = stem.match(/^[A-Z]\.[\s\S]+/gm) || [];
                        stem = stem.replace(/^[A-Z]\.[\s\S]+/gm, '').trim();
                        const correctAnswers = answer.split('');
                        
                        optionLines.forEach(line => {
                            const optionLetter = line.charAt(0);
                            const optionText = line.substring(2).trim();
                            optionsArray.push({ text: optionText, isCorrect: correctAnswers.includes(optionLetter) });
                        });
                        q.options = JSON.stringify(optionsArray);
                        q.answer = optionsArray.filter(opt => opt.isCorrect).map(opt => opt.text).join(', ');
                    } else {
                        q.answer = answer;
                    }
                    
                    q.stem = stem;
                    questions.push(q);
                });
            });
            return questions;
        };


        DOMElements.importJsonInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!Array.isArray(data)) throw new Error('JSON is not an array.');
                    await db.questions.bulkPut(data);
                    alert(`${data.length} 条题目导入/更新成功!`);
                    await fetchAndRender();
                    closeIOModal();
                } catch (error) { alert('导入失败: ' + error.message); }
            };
            reader.readAsText(file);
        });

        DOMElements.importDocxInput.addEventListener('change', async (e) => {
             const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const arrayBuffer = event.target.result;
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    const text = result.value;
                    const questions = parseDocxContent(text);
                    if (questions.length === 0) throw new Error("未能从文件中解析出有效题目。请检查模板格式。");
                    await db.questions.bulkAdd(questions);
                    alert(`${questions.length} 条题目从DOCX导入成功!`);
                    await fetchAndRender();
                    closeIOModal();
                } catch(error) { alert('DOCX 导入失败: ' + error.message); }
            };
            reader.readAsArrayBuffer(file);
        });

        const downloadFile = (blob, filename) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        DOMElements.exportJsonBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            const data = getFilteredQuestions();
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            downloadFile(blob, `q-bank-export-${new Date().toISOString().slice(0,10)}.json`);
        });

        DOMElements.exportCsvBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            const data = getFilteredQuestions().map(q => ({
                ...q, 
                tags: q.tags.join(','), 
                subQuestions: q.subQuestions ? JSON.stringify(q.subQuestions) : '', 
                options: q.options ? JSON.stringify(q.options) : ''
            }));
            const csvString = Papa.unparse(data);
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, `q-bank-export-${new Date().toISOString().slice(0,10)}.csv`);
        });

        DOMElements.exportDocxBtn.addEventListener('click', async () => {
            triggerHapticFeedback();
            const data = getFilteredQuestions();
            let htmlContent = ``;
            data.forEach(q => {
                htmlContent += `<div>${renderMarkdown(q.stem)}</div><br><p><strong>答案:</strong></p><div>${renderMarkdown(q.answer)}</div><br><p><strong>解析:</strong></p><div>${renderMarkdown(q.analysis || '')}</div><hr>`;
            });
            const blob = htmlDocx.asBlob(htmlContent);
            downloadFile(blob, `q-bank-export-${new Date().toISOString().slice(0,10)}.docx`);
        });

        DOMElements.downloadJsonTemplateBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            const jsonTemplate = [
              {
                "type": "standard",
                "stem": "标准题题干示例：\n\n中国首都是哪里？",
                "answer": "北京",
                "analysis": "这是一个常识性问题。",
                "tags": ["地理", "常识"],
                "reviewStatus": "new",
                "options": null,
                "subQuestions": null
              },
              {
                "type": "single-choice",
                "stem": "单选题题干示例：\n\n以下哪个是前端框架？",
                "answer": "React",
                "analysis": "React 是一个流行的前端JavaScript库。",
                "tags": ["编程", "前端"],
                "options": '[{"text": "Django", "isCorrect": false},{"text": "React", "isCorrect": true},{"text": "Flask", "isCorrect": false}]',
                "subQuestions": null,
                "reviewStatus": "new"
              },
              {
                  "type": "material",
                  "stem": "材料题题干示例：\n\n阅读以下关于太阳系的描述，并回答问题。",
                  "answer": "见子问题解析",
                  "subQuestions": '[{ "id": "uuid-1", "type": "standard", "stem": "太阳系中最大的行星是哪颗？", "answer": "木星", "analysis": "" },{ "id": "uuid-2", "type": "single-choice", "stem": "哪颗行星被称为“红色星球”？", "options": [{"text": "地球", "isCorrect": false}, {"text": "火星", "isCorrect": true}], "answer": "火星", "analysis": "" }]',
                  "analysis": "这是关于整个材料的整体解析。",
                  "tags": ["综合", "天文"],
                  "reviewStatus": "new",
                  "options": null
              }
            ];
            const jsonString = JSON.stringify(jsonTemplate, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            downloadFile(blob, `q-bank-template.json`);
        });

        DOMElements.downloadCsvTemplateBtn.addEventListener('click', () => {
            triggerHapticFeedback();
            const csvTemplateData = [
              {
                type: 'standard',
                stem: '标准题题干：中国首都是哪里？',
                answer: '北京',
                analysis: '这是一个常识性问题。',
                tags: '地理,常识',
                options: '',
                subQuestions: ''
              },
              {
                type: 'single-choice',
                stem: '单选题题干：以下哪个是前端框架？',
                answer: 'React',
                analysis: 'React 是一个流行的前端JavaScript库。',
                tags: '编程,前端',
                options: '[{"text":"Django","isCorrect":false},{"text":"React","isCorrect":true}]',
                subQuestions: ''
              }
            ];
            const csvString = Papa.unparse(csvTemplateData);
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, `q-bank-template.csv`);
        });

        DOMElements.downloadDocxTemplateBtn.addEventListener('click', async () => {
            triggerHapticFeedback();
            const docxTemplateHtml = `
              <h1>Q-Bank Word 导入模板</h1>
              <p>请严格遵循以下格式来组织您的题目。每个题目以 "<strong>Q:</strong>" 开头，以 "<strong>---END---</strong>" 结尾。</p>
              <hr>
              
              <h2>标准题 (Standard)</h2>
              <p><strong>Q:</strong> 中国的首都是哪里？</p>
              <p><strong>A:</strong> 北京</p>
              <p><strong>T:</strong> 地理, 常识</p>
              <p><strong>Analysis:</strong> 这是北京的介绍。</p>
              <p><strong>---END---</strong></p>
              <hr>

              <h2>单选题 (Single-Choice)</h2>
              <p><em>(在正确选项后用 <strong>(Correct)</strong> 标记)</em></p>
              <p><strong>Q:</strong> 以下哪个不是前端框架？</p>
              <p><strong>Options:</strong></p>
              <p>* React</p>
              <p>* Vue</p>
              <p>* Django (Correct)</p>
              <p><strong>T:</strong> 编程, 前端</p>
              <p><strong>---END---</strong></p>
              <hr>

              <h2>多选题 (Multi-Choice)</h2>
              <p><em>(在所有正确选项后用 <strong>(Correct)</strong> 标记)</em></p>
              <p><strong>Q:</strong> 以下哪些是编程语言？</p>
              <p><strong>Options:</strong></p>
              <p>* Python (Correct)</p>
              <p>* HTML</p>
              <p>* Java (Correct)</p>
              <p><strong>---END---</strong></p>
              <hr>

              <h2>材料题 (Material)</h2>
              <p><em>(在主问题 "<strong>Q:</strong>" 后跟上子问题块 "<strong>SubQuestions:</strong>"，子问题之间用 "<strong>---</strong>" 分隔)</em></p>
              <p><strong>Q:</strong> 阅读以下唐诗，并回答问题。<br><strong>春晓</strong><br><em>孟浩然</em><br>春眠不觉晓，处处闻啼鸟。<br>夜来风雨声，花落知多少。</p>
              <p><strong>SubQuestions:</strong></p>
              <p><strong>SQ:</strong> 这首诗的作者是谁？</p>
              <p><strong>SA:</strong> 孟浩然</p>
              <p>---</p>
              <p><strong>SQ:</strong> 这首诗描写的哪个季节？</p>
              <p><strong>SQ_Options:</strong></p>
              <p>* 春季 (Correct)</p>
              <p>* 夏季</p>
              <p>* 秋季</p>
              <p><strong>T:</strong> 文学, 唐诗</p>
              <p><strong>Analysis:</strong> 这是对整道材料题的统一解析。</p>
              <p><strong>---END---</strong></p>
            `;
            const blob = htmlDocx.asBlob(docxTemplateHtml);
            downloadFile(blob, `q-bank-template.docx`);
        });

        // --- 14. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', fetchAndRender);
    </script>
</body>
</html>

